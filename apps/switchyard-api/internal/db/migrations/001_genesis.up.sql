-- Enclii Genesis Schema
-- Generated by squashing migrations 000-023
-- Date: 2026-01-19

-- Name: cleanup_expired_invitations(); Type: FUNCTION; Schema: public; Owner: -

CREATE FUNCTION public.cleanup_expired_invitations() RETURNS void
    LANGUAGE plpgsql
    AS $$
BEGIN
    UPDATE team_invitations
    SET status = 'expired', updated_at = NOW()
    WHERE status = 'pending' AND expires_at < NOW();
END;
$$;
-- Name: increment_template_deploy_count(); Type: FUNCTION; Schema: public; Owner: -

CREATE FUNCTION public.increment_template_deploy_count() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    IF NEW.status = 'completed' AND (OLD IS NULL OR OLD.status != 'completed') THEN
        UPDATE templates SET deploy_count = deploy_count + 1, updated_at = NOW()
        WHERE id = NEW.template_id;
    END IF;
    RETURN NEW;
END;
$$;
-- Name: update_api_tokens_updated_at(); Type: FUNCTION; Schema: public; Owner: -

CREATE FUNCTION public.update_api_tokens_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$;
-- Name: update_build_jobs_updated_at(); Type: FUNCTION; Schema: public; Owner: -

CREATE FUNCTION public.update_build_jobs_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$;
-- Name: update_database_addons_updated_at(); Type: FUNCTION; Schema: public; Owner: -

CREATE FUNCTION public.update_database_addons_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$;
-- Name: update_env_var_updated_at(); Type: FUNCTION; Schema: public; Owner: -

CREATE FUNCTION public.update_env_var_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$;
-- Name: update_functions_updated_at(); Type: FUNCTION; Schema: public; Owner: -

CREATE FUNCTION public.update_functions_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$;
-- Name: update_github_installations_updated_at(); Type: FUNCTION; Schema: public; Owner: -

CREATE FUNCTION public.update_github_installations_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$;
-- Name: update_github_repositories_updated_at(); Type: FUNCTION; Schema: public; Owner: -

CREATE FUNCTION public.update_github_repositories_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$;
-- Name: update_team_invitations_updated_at(); Type: FUNCTION; Schema: public; Owner: -

CREATE FUNCTION public.update_team_invitations_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$;
-- Name: update_updated_at_column(); Type: FUNCTION; Schema: public; Owner: -

CREATE FUNCTION public.update_updated_at_column() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$;
-- Name: update_waybill_updated_at(); Type: FUNCTION; Schema: public; Owner: -

CREATE FUNCTION public.update_waybill_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$;
-- Name: update_webhook_destinations_updated_at(); Type: FUNCTION; Schema: public; Owner: -

CREATE FUNCTION public.update_webhook_destinations_updated_at() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$;
-- Name: user_has_access(uuid, uuid, uuid, character varying); Type: FUNCTION; Schema: public; Owner: -

CREATE FUNCTION public.user_has_access(p_user_id uuid, p_project_id uuid, p_environment_id uuid DEFAULT NULL::uuid, p_required_role character varying DEFAULT 'viewer'::character varying) RETURNS boolean
    LANGUAGE plpgsql
    AS $$
DECLARE
    user_role VARCHAR;
    role_hierarchy INT;
    required_hierarchy INT;
BEGIN
    SELECT pa.role INTO user_role
    FROM project_access pa
    WHERE pa.user_id = p_user_id
      AND pa.project_id = p_project_id
      AND (pa.environment_id = p_environment_id OR pa.environment_id IS NULL)
      AND (pa.expires_at IS NULL OR pa.expires_at > NOW())
    LIMIT 1;

    IF user_role IS NULL THEN
        RETURN false;
    END IF;

    role_hierarchy := CASE user_role
        WHEN 'admin' THEN 3
        WHEN 'developer' THEN 2
        WHEN 'viewer' THEN 1
        ELSE 0
    END;

    required_hierarchy := CASE p_required_role
        WHEN 'admin' THEN 3
        WHEN 'developer' THEN 2
        WHEN 'viewer' THEN 1
        ELSE 0
    END;

    RETURN role_hierarchy >= required_hierarchy;
END;
$$;

-- Name: sessions; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.sessions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    token_hash character varying(255) NOT NULL,
    ip_address inet,
    user_agent text,
    expires_at timestamp with time zone NOT NULL,
    revoked_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now()
);
-- Name: users; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.users (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    email character varying(255) NOT NULL,
    password_hash character varying(255),
    name character varying(255) NOT NULL,
    role character varying(50) DEFAULT 'developer'::character varying NOT NULL,
    oidc_subject text,
    oidc_issuer text,
    active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    last_login_at timestamp with time zone
);
-- Name: COLUMN users.role; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.users.role IS 'User role for RBAC: admin, developer, or viewer';
-- Name: COLUMN users.oidc_subject; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.users.oidc_subject IS 'OIDC subject identifier (sub claim) from external provider';
-- Name: COLUMN users.oidc_issuer; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.users.oidc_issuer IS 'OIDC issuer URL (iss claim) from external provider';
-- Name: active_sessions; Type: VIEW; Schema: public; Owner: -

CREATE VIEW public.active_sessions AS
 SELECT s.id,
    s.user_id,
    u.email,
    u.name,
    s.ip_address,
    s.user_agent,
    s.expires_at,
    s.created_at
   FROM (public.sessions s
     JOIN public.users u ON ((s.user_id = u.id)))
  WHERE ((s.revoked_at IS NULL) AND (s.expires_at > now()));
-- Name: api_tokens; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.api_tokens (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    name character varying(255) NOT NULL,
    prefix character varying(20) NOT NULL,
    token_hash character varying(64) NOT NULL,
    scopes text[] DEFAULT '{}'::text[],
    expires_at timestamp with time zone,
    last_used_at timestamp with time zone,
    last_used_ip character varying(45),
    revoked boolean DEFAULT false NOT NULL,
    revoked_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);
-- Name: TABLE api_tokens; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.api_tokens IS 'API tokens for programmatic access (CLI, CI/CD)';
-- Name: COLUMN api_tokens.prefix; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.api_tokens.prefix IS 'First 8 chars of token for identification (e.g., "enclii_ab")';
-- Name: COLUMN api_tokens.token_hash; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.api_tokens.token_hash IS 'SHA-256 hash of the full token (raw token never stored)';
-- Name: COLUMN api_tokens.scopes; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.api_tokens.scopes IS 'Array of permission scopes (empty = full access)';
-- Name: COLUMN api_tokens.expires_at; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.api_tokens.expires_at IS 'Optional expiration timestamp (NULL = never expires)';
-- Name: approval_records; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.approval_records (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    deployment_id uuid NOT NULL,
    pr_url character varying(500),
    pr_number integer,
    approver_email character varying(255),
    approver_name character varying(255),
    approved_at timestamp with time zone,
    ci_status character varying(50),
    change_ticket_url character varying(500),
    compliance_receipt text,
    created_at timestamp with time zone DEFAULT now()
);
-- Name: audit_logs; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.audit_logs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    "timestamp" timestamp with time zone DEFAULT now(),
    actor_id uuid,
    actor_email character varying(255) NOT NULL,
    actor_role character varying(50) NOT NULL,
    action character varying(100) NOT NULL,
    resource_type character varying(50) NOT NULL,
    resource_id character varying(255) NOT NULL,
    resource_name character varying(255),
    project_id uuid,
    environment_id uuid,
    ip_address inet,
    user_agent text,
    outcome character varying(20) NOT NULL,
    context jsonb,
    metadata jsonb
);
-- Name: billing_records; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.billing_records (
    id uuid NOT NULL,
    project_id uuid NOT NULL,
    subscription_id uuid,
    period_start date NOT NULL,
    period_end date NOT NULL,
    plan_id character varying(50),
    plan_amount numeric(10,2) DEFAULT 0 NOT NULL,
    compute_gb_hours numeric(20,6) DEFAULT 0,
    build_minutes numeric(20,6) DEFAULT 0,
    storage_gb_hours numeric(20,6) DEFAULT 0,
    bandwidth_gb numeric(20,6) DEFAULT 0,
    custom_domains integer DEFAULT 0,
    compute_cost numeric(10,2) DEFAULT 0,
    build_cost numeric(10,2) DEFAULT 0,
    storage_cost numeric(10,2) DEFAULT 0,
    bandwidth_cost numeric(10,2) DEFAULT 0,
    subtotal numeric(10,2) DEFAULT 0 NOT NULL,
    credits_applied numeric(10,2) DEFAULT 0,
    total_amount numeric(10,2) DEFAULT 0 NOT NULL,
    currency character varying(3) DEFAULT 'USD'::character varying,
    stripe_invoice_id character varying(255),
    status character varying(50) DEFAULT 'draft'::character varying NOT NULL,
    paid_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);
-- Name: TABLE billing_records; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.billing_records IS 'Monthly billing records and invoices';
-- Name: build_jobs; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.build_jobs (
    id uuid NOT NULL,
    release_id uuid NOT NULL,
    service_id uuid NOT NULL,
    project_id uuid NOT NULL,
    git_sha character varying(255) NOT NULL,
    git_branch character varying(255),
    build_config jsonb DEFAULT '{}'::jsonb NOT NULL,
    status character varying(50) DEFAULT 'queued'::character varying NOT NULL,
    worker_id character varying(255),
    error_message text,
    image_uri character varying(500),
    image_digest character varying(255),
    image_size_bytes bigint,
    sbom text,
    sbom_format character varying(50),
    image_signature text,
    queued_at timestamp with time zone DEFAULT now(),
    started_at timestamp with time zone,
    completed_at timestamp with time zone,
    duration_seconds numeric(10,2),
    callback_url character varying(500),
    callback_status character varying(50),
    priority integer DEFAULT 0,
    retry_count integer DEFAULT 0,
    parent_job_id uuid,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT build_jobs_status_check CHECK (((status)::text = ANY ((ARRAY['queued'::character varying, 'building'::character varying, 'completed'::character varying, 'failed'::character varying, 'cancelled'::character varying])::text[])))
);
-- Name: TABLE build_jobs; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.build_jobs IS 'Historical record of all build jobs processed by Roundhouse';
-- Name: build_metrics; Type: VIEW; Schema: public; Owner: -

CREATE VIEW public.build_metrics AS
 SELECT project_id,
    date_trunc('day'::text, queued_at) AS build_date,
    count(*) AS total_builds,
    count(*) FILTER (WHERE ((status)::text = 'completed'::text)) AS successful_builds,
    count(*) FILTER (WHERE ((status)::text = 'failed'::text)) AS failed_builds,
    avg(duration_seconds) FILTER (WHERE ((status)::text = 'completed'::text)) AS avg_duration_seconds,
    sum(image_size_bytes) FILTER (WHERE ((status)::text = 'completed'::text)) AS total_image_bytes
   FROM public.build_jobs
  GROUP BY project_id, (date_trunc('day'::text, queued_at));
-- Name: VIEW build_metrics; Type: COMMENT; Schema: public; Owner: -

COMMENT ON VIEW public.build_metrics IS 'Aggregated build metrics per project per day';
-- Name: ci_runs; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.ci_runs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    service_id uuid NOT NULL,
    commit_sha character varying(64) NOT NULL,
    workflow_name character varying(255) NOT NULL,
    workflow_id bigint NOT NULL,
    run_id bigint NOT NULL,
    run_number integer NOT NULL,
    status character varying(32) DEFAULT 'queued'::character varying NOT NULL,
    conclusion character varying(32),
    html_url text,
    branch character varying(255),
    event_type character varying(64),
    actor character varying(255),
    started_at timestamp with time zone,
    completed_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);
-- Name: TABLE ci_runs; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.ci_runs IS 'Stores GitHub Actions workflow run status for unified build progress tracking';
-- Name: COLUMN ci_runs.status; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.ci_runs.status IS 'Workflow status: queued, in_progress, completed';
-- Name: COLUMN ci_runs.conclusion; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.ci_runs.conclusion IS 'Final result when completed: success, failure, cancelled, skipped, timed_out, action_required';
-- Name: cloudflare_accounts; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.cloudflare_accounts (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    name character varying(100) NOT NULL,
    account_id character varying(100) NOT NULL,
    api_token_encrypted text NOT NULL,
    zone_id character varying(100),
    created_at timestamp without time zone DEFAULT now() NOT NULL,
    updated_at timestamp without time zone DEFAULT now() NOT NULL
);
-- Name: cloudflare_tunnels; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.cloudflare_tunnels (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    cloudflare_account_id uuid NOT NULL,
    environment_id uuid NOT NULL,
    tunnel_id character varying(100) NOT NULL,
    tunnel_name character varying(100) NOT NULL,
    tunnel_token_encrypted text NOT NULL,
    cname character varying(255) NOT NULL,
    status character varying(50) DEFAULT 'active'::character varying NOT NULL,
    last_health_check timestamp without time zone,
    created_at timestamp without time zone DEFAULT now() NOT NULL,
    updated_at timestamp without time zone DEFAULT now() NOT NULL
);
-- Name: credits; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.credits (
    id uuid NOT NULL,
    project_id uuid NOT NULL,
    amount numeric(10,2) NOT NULL,
    description text,
    expires_at timestamp with time zone,
    used_amount numeric(10,2) DEFAULT 0,
    created_at timestamp with time zone DEFAULT now()
);
-- Name: TABLE credits; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.credits IS 'Promotional credits and balances';
-- Name: custom_domains; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.custom_domains (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    service_id uuid NOT NULL,
    environment_id uuid NOT NULL,
    domain character varying(255) NOT NULL,
    verified boolean DEFAULT false NOT NULL,
    tls_enabled boolean DEFAULT true NOT NULL,
    tls_issuer character varying(100) DEFAULT 'letsencrypt-prod'::character varying,
    created_at timestamp without time zone DEFAULT now() NOT NULL,
    updated_at timestamp without time zone DEFAULT now() NOT NULL,
    verified_at timestamp without time zone,
    cloudflare_tunnel_id uuid,
    is_platform_domain boolean DEFAULT false NOT NULL,
    zero_trust_enabled boolean DEFAULT false NOT NULL,
    access_policy_id character varying(100),
    tls_provider character varying(50) DEFAULT 'cert-manager'::character varying,
    status character varying(50) DEFAULT 'pending'::character varying NOT NULL,
    dns_cname character varying(255)
);
-- Name: daily_usage; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.daily_usage (
    id uuid NOT NULL,
    project_id uuid NOT NULL,
    metric_type character varying(50) NOT NULL,
    value numeric(20,6) DEFAULT 0 NOT NULL,
    date date NOT NULL,
    created_at timestamp with time zone DEFAULT now()
);
-- Name: TABLE daily_usage; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.daily_usage IS 'Daily aggregated usage metrics';
-- Name: database_addon_backups; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.database_addon_backups (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    addon_id uuid NOT NULL,
    backup_type character varying(50) DEFAULT 'scheduled'::character varying NOT NULL,
    status character varying(50) DEFAULT 'pending'::character varying NOT NULL,
    status_message text,
    storage_path character varying(1024),
    size_bytes bigint,
    started_at timestamp with time zone,
    completed_at timestamp with time zone,
    expires_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT valid_backup_status CHECK (((status)::text = ANY ((ARRAY['pending'::character varying, 'in_progress'::character varying, 'completed'::character varying, 'failed'::character varying])::text[]))),
    CONSTRAINT valid_backup_type CHECK (((backup_type)::text = ANY ((ARRAY['scheduled'::character varying, 'manual'::character varying, 'pre_delete'::character varying])::text[])))
);
-- Name: TABLE database_addon_backups; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.database_addon_backups IS 'Backup history for database addons';
-- Name: COLUMN database_addon_backups.storage_path; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.database_addon_backups.storage_path IS 'S3/R2 path where backup is stored';
-- Name: database_addon_bindings; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.database_addon_bindings (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    addon_id uuid NOT NULL,
    service_id uuid NOT NULL,
    env_var_name character varying(255) DEFAULT 'DATABASE_URL'::character varying NOT NULL,
    status character varying(50) DEFAULT 'active'::character varying NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT valid_binding_status CHECK (((status)::text = ANY ((ARRAY['active'::character varying, 'suspended'::character varying, 'deleted'::character varying])::text[])))
);
-- Name: TABLE database_addon_bindings; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.database_addon_bindings IS 'Links database addons to services for automatic env var injection';
-- Name: COLUMN database_addon_bindings.env_var_name; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.database_addon_bindings.env_var_name IS 'Environment variable name to inject (e.g., DATABASE_URL, REDIS_URL)';
-- Name: database_addons; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.database_addons (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    environment_id uuid,
    type character varying(50) NOT NULL,
    name character varying(255) NOT NULL,
    status character varying(50) DEFAULT 'pending'::character varying NOT NULL,
    status_message text,
    config jsonb DEFAULT '{}'::jsonb NOT NULL,
    k8s_namespace character varying(255),
    k8s_resource_name character varying(255),
    connection_secret character varying(255),
    host character varying(255),
    port integer,
    database_name character varying(255),
    username character varying(255),
    storage_used_bytes bigint DEFAULT 0,
    connections_active integer DEFAULT 0,
    last_backup_at timestamp with time zone,
    created_by uuid,
    created_by_email character varying(255),
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    provisioned_at timestamp with time zone,
    deleted_at timestamp with time zone,
    CONSTRAINT valid_addon_status CHECK (((status)::text = ANY ((ARRAY['pending'::character varying, 'provisioning'::character varying, 'ready'::character varying, 'failed'::character varying, 'deleting'::character varying, 'deleted'::character varying])::text[]))),
    CONSTRAINT valid_addon_type CHECK (((type)::text = ANY ((ARRAY['postgres'::character varying, 'redis'::character varying, 'mysql'::character varying])::text[])))
);
-- Name: TABLE database_addons; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.database_addons IS 'Database add-ons for one-click PostgreSQL, Redis, MySQL provisioning';
-- Name: COLUMN database_addons.type; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.database_addons.type IS 'Database type: postgres, redis, mysql';
-- Name: COLUMN database_addons.config; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.database_addons.config IS 'JSON configuration: {version, storage_gb, cpu, memory, ha_enabled}';
-- Name: COLUMN database_addons.k8s_resource_name; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.database_addons.k8s_resource_name IS 'Name of the K8s resource (e.g., CloudNativePG Cluster name)';
-- Name: COLUMN database_addons.connection_secret; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.database_addons.connection_secret IS 'K8s Secret name containing database credentials';
-- Name: deployment_groups; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.deployment_groups (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    environment_id uuid NOT NULL,
    name character varying(255),
    status character varying(50) DEFAULT 'pending'::character varying NOT NULL,
    strategy character varying(50) DEFAULT 'dependency_ordered'::character varying NOT NULL,
    triggered_by character varying(255),
    git_sha character varying(40),
    pr_url text,
    started_at timestamp with time zone,
    completed_at timestamp with time zone,
    error_message text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);
-- Name: TABLE deployment_groups; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.deployment_groups IS 'Coordinates atomic multi-service deployments with dependency ordering';
-- Name: COLUMN deployment_groups.strategy; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.deployment_groups.strategy IS 'Deployment strategy: parallel (all at once), dependency_ordered (topological sort), sequential (one by one)';
-- Name: COLUMN deployment_groups.triggered_by; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.deployment_groups.triggered_by IS 'What initiated this deployment: webhook, manual, promotion, rollback';
-- Name: deployments; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.deployments (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    release_id uuid NOT NULL,
    environment_id uuid NOT NULL,
    replicas integer DEFAULT 1 NOT NULL,
    status character varying(50) DEFAULT 'pending'::character varying NOT NULL,
    health character varying(50) DEFAULT 'unknown'::character varying NOT NULL,
    deployed_by uuid,
    pr_url character varying(500),
    commit_message text,
    sbom text,
    image_signature text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    group_id uuid,
    deploy_order integer DEFAULT 0,
    preview_environment_id uuid,
    error_message text
);
-- Name: COLUMN deployments.deploy_order; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.deployments.deploy_order IS 'Order within deployment group (0 = first layer, 1 = second layer, etc.)';
-- Name: COLUMN deployments.error_message; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.deployments.error_message IS 'Error message from reconciliation failure, NULL if deployment succeeded';
-- Name: env_var_audit_logs; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.env_var_audit_logs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    env_var_id uuid NOT NULL,
    service_id uuid NOT NULL,
    environment_id uuid,
    action character varying(50) NOT NULL,
    key character varying(255) NOT NULL,
    old_value_hash character varying(64),
    new_value_hash character varying(64),
    actor_id uuid,
    actor_email character varying(255) NOT NULL,
    actor_ip character varying(45),
    user_agent text,
    "timestamp" timestamp with time zone DEFAULT now() NOT NULL
);
-- Name: TABLE env_var_audit_logs; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.env_var_audit_logs IS 'Immutable audit trail for environment variable changes';
-- Name: environment_variables; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.environment_variables (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    service_id uuid NOT NULL,
    environment_id uuid,
    key character varying(255) NOT NULL,
    value_encrypted text NOT NULL,
    is_secret boolean DEFAULT false NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    created_by uuid,
    created_by_email character varying(255)
);
-- Name: TABLE environment_variables; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.environment_variables IS 'Service environment variables and secrets with encryption at rest';
-- Name: COLUMN environment_variables.environment_id; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.environment_variables.environment_id IS 'NULL means variable applies to all environments';
-- Name: COLUMN environment_variables.value_encrypted; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.environment_variables.value_encrypted IS 'AES-256-GCM encrypted value, base64 encoded';
-- Name: COLUMN environment_variables.is_secret; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.environment_variables.is_secret IS 'If true, value is masked in API responses and UI';
-- Name: environments; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.environments (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    name character varying(255) NOT NULL,
    kube_namespace character varying(255) NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);
-- Name: function_invocations; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.function_invocations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    function_id uuid NOT NULL,
    started_at timestamp with time zone NOT NULL,
    duration_ms bigint,
    status_code integer,
    cold_start boolean DEFAULT false,
    error_type character varying(255),
    request_id character varying(255),
    created_at timestamp with time zone DEFAULT now() NOT NULL
)
PARTITION BY RANGE (created_at);
-- Name: TABLE function_invocations; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.function_invocations IS 'Individual function invocation records for analytics and debugging';
-- Name: COLUMN function_invocations.cold_start; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.function_invocations.cold_start IS 'Whether this invocation triggered a scale-up from zero';
-- Name: COLUMN function_invocations.request_id; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.function_invocations.request_id IS 'Unique request ID for distributed tracing';
-- Name: function_invocations_2026_01; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.function_invocations_2026_01 (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    function_id uuid NOT NULL,
    started_at timestamp with time zone NOT NULL,
    duration_ms bigint,
    status_code integer,
    cold_start boolean DEFAULT false,
    error_type character varying(255),
    request_id character varying(255),
    created_at timestamp with time zone DEFAULT now() NOT NULL
);
-- Name: function_invocations_2026_02; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.function_invocations_2026_02 (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    function_id uuid NOT NULL,
    started_at timestamp with time zone NOT NULL,
    duration_ms bigint,
    status_code integer,
    cold_start boolean DEFAULT false,
    error_type character varying(255),
    request_id character varying(255),
    created_at timestamp with time zone DEFAULT now() NOT NULL
);
-- Name: function_invocations_2026_03; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.function_invocations_2026_03 (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    function_id uuid NOT NULL,
    started_at timestamp with time zone NOT NULL,
    duration_ms bigint,
    status_code integer,
    cold_start boolean DEFAULT false,
    error_type character varying(255),
    request_id character varying(255),
    created_at timestamp with time zone DEFAULT now() NOT NULL
);
-- Name: function_invocations_2026_04; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.function_invocations_2026_04 (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    function_id uuid NOT NULL,
    started_at timestamp with time zone NOT NULL,
    duration_ms bigint,
    status_code integer,
    cold_start boolean DEFAULT false,
    error_type character varying(255),
    request_id character varying(255),
    created_at timestamp with time zone DEFAULT now() NOT NULL
);
-- Name: function_invocations_default; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.function_invocations_default (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    function_id uuid NOT NULL,
    started_at timestamp with time zone NOT NULL,
    duration_ms bigint,
    status_code integer,
    cold_start boolean DEFAULT false,
    error_type character varying(255),
    request_id character varying(255),
    created_at timestamp with time zone DEFAULT now() NOT NULL
);
-- Name: function_metrics; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.function_metrics (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    function_id uuid NOT NULL,
    period character varying(20) NOT NULL,
    period_start timestamp with time zone NOT NULL,
    period_end timestamp with time zone NOT NULL,
    total_invocations bigint DEFAULT 0,
    success_count bigint DEFAULT 0,
    error_count bigint DEFAULT 0,
    cold_start_count bigint DEFAULT 0,
    avg_duration_ms double precision DEFAULT 0,
    p50_duration_ms double precision DEFAULT 0,
    p95_duration_ms double precision DEFAULT 0,
    p99_duration_ms double precision DEFAULT 0,
    created_at timestamp with time zone DEFAULT now()
);
-- Name: TABLE function_metrics; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.function_metrics IS 'Pre-aggregated metrics for efficient dashboard queries';
-- Name: COLUMN function_metrics.period; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.function_metrics.period IS 'Aggregation period: hourly, daily, weekly';
-- Name: functions; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.functions (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    name character varying(255) NOT NULL,
    config jsonb DEFAULT '{}'::jsonb NOT NULL,
    status character varying(50) DEFAULT 'pending'::character varying NOT NULL,
    status_message text,
    k8s_namespace character varying(255),
    k8s_resource_name character varying(255),
    image_uri text,
    endpoint text,
    available_replicas integer DEFAULT 0,
    invocation_count bigint DEFAULT 0,
    avg_duration_ms double precision DEFAULT 0,
    last_invoked_at timestamp with time zone,
    created_by uuid,
    created_by_email character varying(255),
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    deployed_at timestamp with time zone,
    deleted_at timestamp with time zone,
    CONSTRAINT valid_function_status CHECK (((status)::text = ANY ((ARRAY['pending'::character varying, 'building'::character varying, 'deploying'::character varying, 'ready'::character varying, 'failed'::character varying, 'deleting'::character varying])::text[])))
);
-- Name: TABLE functions; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.functions IS 'Serverless functions with scale-to-zero autoscaling via KEDA';
-- Name: COLUMN functions.config; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.functions.config IS 'JSON configuration: {runtime, handler, memory, cpu, timeout, minReplicas, maxReplicas, cooldownPeriod, concurrency}';
-- Name: COLUMN functions.status; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.functions.status IS 'Lifecycle status: pending, building, deploying, ready, failed, deleting';
-- Name: COLUMN functions.endpoint; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.functions.endpoint IS 'Public endpoint URL (e.g., https://hello.fn.enclii.dev)';
-- Name: COLUMN functions.available_replicas; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.functions.available_replicas IS 'Current number of running pods (0 = scaled to zero)';
-- Name: github_installations; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.github_installations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    installation_id bigint NOT NULL,
    account_login character varying(255) NOT NULL,
    account_type character varying(50) NOT NULL,
    access_tokens_url text,
    repositories_url text,
    permissions jsonb DEFAULT '{}'::jsonb,
    events jsonb DEFAULT '[]'::jsonb,
    suspended_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);
-- Name: github_repositories; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.github_repositories (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    installation_id uuid NOT NULL,
    service_id uuid,
    repo_id bigint NOT NULL,
    repo_full_name character varying(255) NOT NULL,
    repo_name character varying(255) NOT NULL,
    default_branch character varying(255) DEFAULT 'main'::character varying,
    private boolean DEFAULT false NOT NULL,
    webhook_id bigint,
    webhook_secret character varying(255),
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL
);
-- Name: hourly_usage; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.hourly_usage (
    id uuid NOT NULL,
    project_id uuid NOT NULL,
    metric_type character varying(50) NOT NULL,
    value numeric(20,6) DEFAULT 0 NOT NULL,
    hour timestamp with time zone NOT NULL,
    created_at timestamp with time zone DEFAULT now()
);
-- Name: TABLE hourly_usage; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.hourly_usage IS 'Hourly aggregated usage metrics';
-- Name: preview_access_logs; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.preview_access_logs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    preview_id uuid NOT NULL,
    accessed_at timestamp with time zone DEFAULT now(),
    path text,
    user_agent text,
    ip_address inet,
    user_id uuid,
    status_code integer,
    response_time_ms integer
);
-- Name: TABLE preview_access_logs; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.preview_access_logs IS 'Access logs for preview environments to track usage and enable auto-sleep';
-- Name: preview_comments; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.preview_comments (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    preview_id uuid NOT NULL,
    user_id uuid NOT NULL,
    user_email character varying(255) NOT NULL,
    user_name character varying(255),
    content text NOT NULL,
    path text,
    x_position integer,
    y_position integer,
    status character varying(50) DEFAULT 'active'::character varying NOT NULL,
    resolved_at timestamp with time zone,
    resolved_by uuid,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);
-- Name: TABLE preview_comments; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.preview_comments IS 'Collaborative comments on preview deployments like Vercel comment feature';
-- Name: COLUMN preview_comments.x_position; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.preview_comments.x_position IS 'Optional X coordinate for visual feedback on specific elements';
-- Name: preview_environments; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.preview_environments (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    service_id uuid NOT NULL,
    pr_number integer NOT NULL,
    pr_title text,
    pr_url text,
    pr_author character varying(255),
    pr_branch character varying(255) NOT NULL,
    pr_base_branch character varying(255) DEFAULT 'main'::character varying NOT NULL,
    commit_sha character varying(40) NOT NULL,
    preview_subdomain character varying(255) NOT NULL,
    preview_url text NOT NULL,
    status character varying(50) DEFAULT 'pending'::character varying NOT NULL,
    status_message text,
    auto_sleep_after integer DEFAULT 30 NOT NULL,
    last_accessed_at timestamp with time zone DEFAULT now(),
    sleeping_since timestamp with time zone,
    deployment_id uuid,
    build_logs_url text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    closed_at timestamp with time zone
);
-- Name: TABLE preview_environments; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.preview_environments IS 'Ephemeral environments created automatically for pull requests, similar to Vercel/Railway preview deployments';
-- Name: COLUMN preview_environments.preview_subdomain; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.preview_environments.preview_subdomain IS 'Unique subdomain like pr-123-myservice for routing';
-- Name: COLUMN preview_environments.auto_sleep_after; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.preview_environments.auto_sleep_after IS 'Minutes of inactivity before auto-sleeping (0 = never)';
-- Name: COLUMN preview_environments.sleeping_since; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.preview_environments.sleeping_since IS 'When the preview went to sleep (null if active)';
-- Name: pricing_plans; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.pricing_plans (
    id character varying(50) NOT NULL,
    name character varying(100) NOT NULL,
    description text,
    price_monthly numeric(10,2) NOT NULL,
    includes jsonb DEFAULT '{}'::jsonb NOT NULL,
    overage_rates jsonb DEFAULT '{}'::jsonb NOT NULL,
    features jsonb DEFAULT '[]'::jsonb,
    is_active boolean DEFAULT true,
    sort_order integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);
-- Name: TABLE pricing_plans; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.pricing_plans IS 'Available subscription plans';
-- Name: project_access; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.project_access (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    user_id uuid NOT NULL,
    project_id uuid NOT NULL,
    environment_id uuid,
    role character varying(50) NOT NULL,
    granted_by uuid NOT NULL,
    granted_at timestamp with time zone DEFAULT now(),
    expires_at timestamp with time zone
);
-- Name: projects; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.projects (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    name character varying(255) NOT NULL,
    slug character varying(255) NOT NULL,
    description text,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    team_id uuid
);
-- Name: COLUMN projects.team_id; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.projects.team_id IS 'Team that owns this project (NULL for personal projects)';
-- Name: subscriptions; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.subscriptions (
    id uuid NOT NULL,
    project_id uuid NOT NULL,
    team_id uuid,
    plan_id character varying(50) NOT NULL,
    stripe_customer_id character varying(255),
    stripe_subscription_id character varying(255),
    status character varying(50) DEFAULT 'active'::character varying NOT NULL,
    current_period_start timestamp with time zone,
    current_period_end timestamp with time zone,
    cancel_at timestamp with time zone,
    cancelled_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);
-- Name: TABLE subscriptions; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.subscriptions IS 'Project subscriptions to pricing plans';
-- Name: project_usage_summary; Type: VIEW; Schema: public; Owner: -

CREATE VIEW public.project_usage_summary AS
 SELECT p.id AS project_id,
    p.name AS project_name,
    s.plan_id,
    s.status AS subscription_status,
    COALESCE(sum(hu.value) FILTER (WHERE ((hu.metric_type)::text = 'compute_gb_hours'::text)), (0)::numeric) AS compute_gb_hours,
    COALESCE(sum(hu.value) FILTER (WHERE ((hu.metric_type)::text = 'build_minutes'::text)), (0)::numeric) AS build_minutes,
    COALESCE(sum(hu.value) FILTER (WHERE ((hu.metric_type)::text = 'storage_gb_hours'::text)), (0)::numeric) AS storage_gb_hours,
    COALESCE(sum(hu.value) FILTER (WHERE ((hu.metric_type)::text = 'bandwidth_gb'::text)), (0)::numeric) AS bandwidth_gb
   FROM ((public.projects p
     LEFT JOIN public.subscriptions s ON ((p.id = s.project_id)))
     LEFT JOIN public.hourly_usage hu ON (((p.id = hu.project_id) AND (hu.hour >= date_trunc('month'::text, CURRENT_TIMESTAMP)))))
  GROUP BY p.id, p.name, s.plan_id, s.status;
-- Name: releases; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.releases (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    service_id uuid NOT NULL,
    version character varying(255) NOT NULL,
    image_uri character varying(500) NOT NULL,
    git_sha character varying(255) NOT NULL,
    status character varying(50) DEFAULT 'building'::character varying NOT NULL,
    sbom text,
    sbom_format character varying(50),
    image_signature text,
    signature_verified_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    error_message text
);
-- Name: COLUMN releases.error_message; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.releases.error_message IS 'Error message from build failure, NULL if build succeeded';
-- Name: rotation_audit_logs; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.rotation_audit_logs (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    event_id uuid NOT NULL,
    service_id uuid,
    service_name character varying(255) NOT NULL,
    environment character varying(50) NOT NULL,
    secret_name character varying(255) NOT NULL,
    secret_path text NOT NULL,
    old_version integer NOT NULL,
    new_version integer NOT NULL,
    status character varying(50) NOT NULL,
    started_at timestamp with time zone NOT NULL,
    completed_at timestamp with time zone,
    duration_ms bigint,
    rollout_strategy character varying(50),
    pods_restarted integer DEFAULT 0,
    error text,
    changed_by character varying(255),
    triggered_by character varying(50) NOT NULL,
    created_at timestamp with time zone DEFAULT now()
);
-- Name: routes; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.routes (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    service_id uuid NOT NULL,
    environment_id uuid NOT NULL,
    path character varying(500) NOT NULL,
    path_type character varying(50) DEFAULT 'Prefix'::character varying NOT NULL,
    port integer DEFAULT 80 NOT NULL,
    created_at timestamp without time zone DEFAULT now() NOT NULL,
    updated_at timestamp without time zone DEFAULT now() NOT NULL
);
-- Name: service_dependencies; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.service_dependencies (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    service_id uuid NOT NULL,
    depends_on_service_id uuid NOT NULL,
    dependency_type character varying(50) DEFAULT 'runtime'::character varying NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    CONSTRAINT no_self_dependency CHECK ((service_id <> depends_on_service_id))
);
-- Name: TABLE service_dependencies; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.service_dependencies IS 'Defines inter-service dependencies for deployment ordering via topological sort';
-- Name: COLUMN service_dependencies.dependency_type; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.service_dependencies.dependency_type IS 'Type of dependency: runtime (must run before), build (build-time), data (migration)';
-- Name: services; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.services (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    name character varying(255) NOT NULL,
    git_repo character varying(500) NOT NULL,
    build_config jsonb DEFAULT '{}'::jsonb NOT NULL,
    volumes jsonb DEFAULT '[]'::jsonb,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    auto_deploy boolean DEFAULT true NOT NULL,
    auto_deploy_branch character varying(255) DEFAULT 'main'::character varying NOT NULL,
    auto_deploy_env character varying(255) DEFAULT 'production'::character varying NOT NULL,
    github_repo_id uuid,
    app_path character varying(500) DEFAULT ''::character varying,
    k8s_namespace character varying(255),
    health character varying(50) DEFAULT 'unknown'::character varying NOT NULL,
    status character varying(50) DEFAULT 'unknown'::character varying NOT NULL,
    desired_replicas integer DEFAULT 0 NOT NULL,
    ready_replicas integer DEFAULT 0 NOT NULL,
    last_health_check timestamp with time zone
);
-- Name: COLUMN services.auto_deploy; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.services.auto_deploy IS 'Enable automatic deployment after successful webhook-triggered builds';
-- Name: COLUMN services.auto_deploy_branch; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.services.auto_deploy_branch IS 'Branch to auto-deploy from (e.g., main, master)';
-- Name: COLUMN services.auto_deploy_env; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.services.auto_deploy_env IS 'Target environment for auto-deployments (e.g., development, staging)';
-- Name: COLUMN services.app_path; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.services.app_path IS 'Monorepo subdirectory path (e.g., apps/api, packages/web). Empty string means root of repository.';
-- Name: team_invitations; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.team_invitations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    team_id uuid NOT NULL,
    email character varying(255) NOT NULL,
    role character varying(50) DEFAULT 'member'::character varying NOT NULL,
    invited_by uuid NOT NULL,
    token character varying(255) NOT NULL,
    status character varying(50) DEFAULT 'pending'::character varying NOT NULL,
    expires_at timestamp with time zone DEFAULT (now() + '7 days'::interval) NOT NULL,
    accepted_at timestamp with time zone,
    declined_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);
-- Name: TABLE team_invitations; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.team_invitations IS 'Pending and historical team invitations';
-- Name: COLUMN team_invitations.role; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.team_invitations.role IS 'Role to assign when invitation is accepted: admin, member, viewer';
-- Name: COLUMN team_invitations.token; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.team_invitations.token IS 'Secure random token for accepting invitation via link';
-- Name: COLUMN team_invitations.status; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.team_invitations.status IS 'Invitation status: pending, accepted, declined, expired';
-- Name: team_members; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.team_members (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    team_id uuid NOT NULL,
    user_id uuid NOT NULL,
    role character varying(50) NOT NULL,
    joined_at timestamp with time zone DEFAULT now(),
    invited_by uuid,
    accepted_at timestamp with time zone
);
-- Name: teams; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.teams (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    name character varying(255) NOT NULL,
    slug character varying(255) NOT NULL,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    description text,
    avatar_url character varying(500),
    billing_email character varying(255),
    settings jsonb DEFAULT '{}'::jsonb,
    owner_id uuid
);
-- Name: COLUMN teams.settings; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.teams.settings IS 'JSON configuration for team-specific settings';
-- Name: COLUMN teams.owner_id; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.teams.owner_id IS 'Primary owner of the team with full administrative rights';
-- Name: template_deployments; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.template_deployments (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    template_id uuid NOT NULL,
    project_id uuid NOT NULL,
    user_id uuid,
    status character varying(50) DEFAULT 'pending'::character varying NOT NULL,
    error_message text,
    created_at timestamp with time zone DEFAULT now(),
    completed_at timestamp with time zone
);
-- Name: templates; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.templates (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    slug character varying(255) NOT NULL,
    name character varying(255) NOT NULL,
    description text,
    long_description text,
    category character varying(100) DEFAULT 'starter'::character varying NOT NULL,
    framework character varying(100),
    language character varying(50),
    tags text[],
    source_type character varying(50) DEFAULT 'github'::character varying NOT NULL,
    source_repo character varying(500),
    source_branch character varying(100) DEFAULT 'main'::character varying,
    source_path character varying(500) DEFAULT '/'::character varying,
    config jsonb DEFAULT '{}'::jsonb NOT NULL,
    icon_url character varying(500),
    preview_url character varying(500),
    screenshot_urls text[],
    author character varying(255),
    author_url character varying(500),
    documentation_url character varying(500),
    deploy_count integer DEFAULT 0,
    star_count integer DEFAULT 0,
    is_official boolean DEFAULT false,
    is_featured boolean DEFAULT false,
    is_public boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now()
);
-- Name: usage_alerts; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.usage_alerts (
    id uuid NOT NULL,
    project_id uuid NOT NULL,
    metric_type character varying(50) NOT NULL,
    threshold_value numeric(20,6) NOT NULL,
    threshold_percent integer,
    notification_sent_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now()
);
-- Name: TABLE usage_alerts; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.usage_alerts IS 'Usage threshold alerts configuration';
-- Name: usage_events; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.usage_events (
    id uuid NOT NULL,
    project_id uuid NOT NULL,
    team_id uuid,
    event_type character varying(100) NOT NULL,
    resource_type character varying(50) NOT NULL,
    resource_id uuid NOT NULL,
    resource_name character varying(255),
    metrics jsonb DEFAULT '{}'::jsonb NOT NULL,
    metadata jsonb DEFAULT '{}'::jsonb,
    "timestamp" timestamp with time zone NOT NULL,
    processed_at timestamp with time zone,
    created_at timestamp with time zone DEFAULT now()
);
-- Name: TABLE usage_events; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.usage_events IS 'Raw usage events from platform services';
-- Name: user_permissions; Type: VIEW; Schema: public; Owner: -

CREATE VIEW public.user_permissions AS
 SELECT u.id AS user_id,
    u.email,
    u.name,
    pa.project_id,
    p.slug AS project_slug,
    pa.environment_id,
    e.name AS environment_name,
    pa.role,
    pa.granted_at,
    pa.expires_at
   FROM (((public.users u
     JOIN public.project_access pa ON ((u.id = pa.user_id)))
     JOIN public.projects p ON ((pa.project_id = p.id)))
     LEFT JOIN public.environments e ON ((pa.environment_id = e.id)))
  WHERE ((u.active = true) AND ((pa.expires_at IS NULL) OR (pa.expires_at > now())));
-- Name: webhook_deliveries; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.webhook_deliveries (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    webhook_id uuid NOT NULL,
    event_type character varying(100) NOT NULL,
    event_id uuid,
    payload jsonb NOT NULL,
    status character varying(50) DEFAULT 'pending'::character varying NOT NULL,
    status_code integer,
    response_body text,
    error_message text,
    attempted_at timestamp with time zone DEFAULT now(),
    completed_at timestamp with time zone,
    duration_ms integer,
    attempt_number integer DEFAULT 1,
    CONSTRAINT valid_delivery_status CHECK (((status)::text = ANY ((ARRAY['pending'::character varying, 'success'::character varying, 'failed'::character varying])::text[])))
);
-- Name: TABLE webhook_deliveries; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.webhook_deliveries IS 'Log of webhook delivery attempts';
-- Name: COLUMN webhook_deliveries.event_type; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.webhook_deliveries.event_type IS 'Event that triggered delivery (e.g., deployment.succeeded)';
-- Name: COLUMN webhook_deliveries.duration_ms; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.webhook_deliveries.duration_ms IS 'Request duration in milliseconds';
-- Name: webhook_destinations; Type: TABLE; Schema: public; Owner: -

CREATE TABLE public.webhook_destinations (
    id uuid DEFAULT gen_random_uuid() NOT NULL,
    project_id uuid NOT NULL,
    name character varying(255) NOT NULL,
    type character varying(50) NOT NULL,
    webhook_url text NOT NULL,
    telegram_bot_token text,
    telegram_chat_id character varying(255),
    custom_headers jsonb DEFAULT '{}'::jsonb,
    signing_secret text,
    events jsonb DEFAULT '["deployment.succeeded", "deployment.failed"]'::jsonb NOT NULL,
    enabled boolean DEFAULT true NOT NULL,
    last_delivery_at timestamp with time zone,
    last_delivery_status character varying(50),
    last_delivery_error text,
    consecutive_failures integer DEFAULT 0,
    auto_disabled_at timestamp with time zone,
    created_by uuid,
    created_by_email character varying(255),
    created_at timestamp with time zone DEFAULT now(),
    updated_at timestamp with time zone DEFAULT now(),
    CONSTRAINT non_telegram_requires_url CHECK ((((type)::text = 'telegram'::text) OR (webhook_url <> ''::text))),
    CONSTRAINT telegram_requires_bot_token CHECK ((((type)::text <> 'telegram'::text) OR ((telegram_bot_token IS NOT NULL) AND (telegram_chat_id IS NOT NULL)))),
    CONSTRAINT valid_last_delivery_status CHECK (((last_delivery_status IS NULL) OR ((last_delivery_status)::text = ANY ((ARRAY['success'::character varying, 'failed'::character varying])::text[])))),
    CONSTRAINT valid_webhook_type CHECK (((type)::text = ANY ((ARRAY['slack'::character varying, 'discord'::character varying, 'telegram'::character varying, 'custom'::character varying])::text[])))
);
-- Name: TABLE webhook_destinations; Type: COMMENT; Schema: public; Owner: -

COMMENT ON TABLE public.webhook_destinations IS 'Webhook endpoints for Slack, Discord, Telegram notifications';
-- Name: COLUMN webhook_destinations.type; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.webhook_destinations.type IS 'Webhook type: slack, discord, telegram, custom';
-- Name: COLUMN webhook_destinations.telegram_bot_token; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.webhook_destinations.telegram_bot_token IS 'Encrypted Telegram bot token';
-- Name: COLUMN webhook_destinations.events; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.webhook_destinations.events IS 'JSON array of subscribed events';
-- Name: COLUMN webhook_destinations.consecutive_failures; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.webhook_destinations.consecutive_failures IS 'Number of consecutive delivery failures';
-- Name: COLUMN webhook_destinations.auto_disabled_at; Type: COMMENT; Schema: public; Owner: -

COMMENT ON COLUMN public.webhook_destinations.auto_disabled_at IS 'When webhook was auto-disabled due to failures';
-- Name: function_invocations_2026_01; Type: TABLE ATTACH; Schema: public; Owner: -

ALTER TABLE ONLY public.function_invocations ATTACH PARTITION public.function_invocations_2026_01 FOR VALUES FROM ('2026-01-01 00:00:00+00') TO ('2026-02-01 00:00:00+00');
-- Name: function_invocations_2026_02; Type: TABLE ATTACH; Schema: public; Owner: -

ALTER TABLE ONLY public.function_invocations ATTACH PARTITION public.function_invocations_2026_02 FOR VALUES FROM ('2026-02-01 00:00:00+00') TO ('2026-03-01 00:00:00+00');
-- Name: function_invocations_2026_03; Type: TABLE ATTACH; Schema: public; Owner: -

ALTER TABLE ONLY public.function_invocations ATTACH PARTITION public.function_invocations_2026_03 FOR VALUES FROM ('2026-03-01 00:00:00+00') TO ('2026-04-01 00:00:00+00');
-- Name: function_invocations_2026_04; Type: TABLE ATTACH; Schema: public; Owner: -

ALTER TABLE ONLY public.function_invocations ATTACH PARTITION public.function_invocations_2026_04 FOR VALUES FROM ('2026-04-01 00:00:00+00') TO ('2026-05-01 00:00:00+00');
-- Name: function_invocations_default; Type: TABLE ATTACH; Schema: public; Owner: -

ALTER TABLE ONLY public.function_invocations ATTACH PARTITION public.function_invocations_default DEFAULT;
-- Name: api_tokens api_tokens_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.api_tokens
    ADD CONSTRAINT api_tokens_pkey PRIMARY KEY (id);
-- Name: api_tokens api_tokens_token_hash_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.api_tokens
    ADD CONSTRAINT api_tokens_token_hash_key UNIQUE (token_hash);
-- Name: approval_records approval_records_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.approval_records
    ADD CONSTRAINT approval_records_pkey PRIMARY KEY (id);
-- Name: audit_logs audit_logs_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.audit_logs
    ADD CONSTRAINT audit_logs_pkey PRIMARY KEY (id);
-- Name: billing_records billing_records_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.billing_records
    ADD CONSTRAINT billing_records_pkey PRIMARY KEY (id);
-- Name: billing_records billing_records_project_id_period_start_period_end_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.billing_records
    ADD CONSTRAINT billing_records_project_id_period_start_period_end_key UNIQUE (project_id, period_start, period_end);
-- Name: build_jobs build_jobs_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.build_jobs
    ADD CONSTRAINT build_jobs_pkey PRIMARY KEY (id);
-- Name: ci_runs ci_runs_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.ci_runs
    ADD CONSTRAINT ci_runs_pkey PRIMARY KEY (id);
-- Name: ci_runs ci_runs_run_id_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.ci_runs
    ADD CONSTRAINT ci_runs_run_id_key UNIQUE (run_id);
-- Name: cloudflare_accounts cloudflare_accounts_account_id_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.cloudflare_accounts
    ADD CONSTRAINT cloudflare_accounts_account_id_key UNIQUE (account_id);
-- Name: cloudflare_accounts cloudflare_accounts_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.cloudflare_accounts
    ADD CONSTRAINT cloudflare_accounts_pkey PRIMARY KEY (id);
-- Name: cloudflare_tunnels cloudflare_tunnels_environment_id_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.cloudflare_tunnels
    ADD CONSTRAINT cloudflare_tunnels_environment_id_key UNIQUE (environment_id);
-- Name: cloudflare_tunnels cloudflare_tunnels_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.cloudflare_tunnels
    ADD CONSTRAINT cloudflare_tunnels_pkey PRIMARY KEY (id);
-- Name: credits credits_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.credits
    ADD CONSTRAINT credits_pkey PRIMARY KEY (id);
-- Name: custom_domains custom_domains_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.custom_domains
    ADD CONSTRAINT custom_domains_pkey PRIMARY KEY (id);
-- Name: custom_domains custom_domains_service_id_environment_id_domain_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.custom_domains
    ADD CONSTRAINT custom_domains_service_id_environment_id_domain_key UNIQUE (service_id, environment_id, domain);
-- Name: daily_usage daily_usage_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.daily_usage
    ADD CONSTRAINT daily_usage_pkey PRIMARY KEY (id);
-- Name: daily_usage daily_usage_project_id_metric_type_date_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.daily_usage
    ADD CONSTRAINT daily_usage_project_id_metric_type_date_key UNIQUE (project_id, metric_type, date);
-- Name: database_addon_backups database_addon_backups_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.database_addon_backups
    ADD CONSTRAINT database_addon_backups_pkey PRIMARY KEY (id);
-- Name: database_addon_bindings database_addon_bindings_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.database_addon_bindings
    ADD CONSTRAINT database_addon_bindings_pkey PRIMARY KEY (id);
-- Name: database_addons database_addons_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.database_addons
    ADD CONSTRAINT database_addons_pkey PRIMARY KEY (id);
-- Name: deployment_groups deployment_groups_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.deployment_groups
    ADD CONSTRAINT deployment_groups_pkey PRIMARY KEY (id);
-- Name: deployments deployments_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.deployments
    ADD CONSTRAINT deployments_pkey PRIMARY KEY (id);
-- Name: deployments deployments_release_id_environment_id_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.deployments
    ADD CONSTRAINT deployments_release_id_environment_id_key UNIQUE (release_id, environment_id);
-- Name: env_var_audit_logs env_var_audit_logs_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.env_var_audit_logs
    ADD CONSTRAINT env_var_audit_logs_pkey PRIMARY KEY (id);
-- Name: environment_variables environment_variables_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.environment_variables
    ADD CONSTRAINT environment_variables_pkey PRIMARY KEY (id);
-- Name: environments environments_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.environments
    ADD CONSTRAINT environments_pkey PRIMARY KEY (id);
-- Name: environments environments_project_id_name_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.environments
    ADD CONSTRAINT environments_project_id_name_key UNIQUE (project_id, name);
-- Name: function_invocations function_invocations_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.function_invocations
    ADD CONSTRAINT function_invocations_pkey PRIMARY KEY (id, created_at);
-- Name: function_invocations_2026_01 function_invocations_2026_01_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.function_invocations_2026_01
    ADD CONSTRAINT function_invocations_2026_01_pkey PRIMARY KEY (id, created_at);
-- Name: function_invocations_2026_02 function_invocations_2026_02_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.function_invocations_2026_02
    ADD CONSTRAINT function_invocations_2026_02_pkey PRIMARY KEY (id, created_at);
-- Name: function_invocations_2026_03 function_invocations_2026_03_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.function_invocations_2026_03
    ADD CONSTRAINT function_invocations_2026_03_pkey PRIMARY KEY (id, created_at);
-- Name: function_invocations_2026_04 function_invocations_2026_04_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.function_invocations_2026_04
    ADD CONSTRAINT function_invocations_2026_04_pkey PRIMARY KEY (id, created_at);
-- Name: function_invocations_default function_invocations_default_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.function_invocations_default
    ADD CONSTRAINT function_invocations_default_pkey PRIMARY KEY (id, created_at);
-- Name: function_metrics function_metrics_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.function_metrics
    ADD CONSTRAINT function_metrics_pkey PRIMARY KEY (id);
-- Name: functions functions_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.functions
    ADD CONSTRAINT functions_pkey PRIMARY KEY (id);
-- Name: github_installations github_installations_installation_id_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.github_installations
    ADD CONSTRAINT github_installations_installation_id_key UNIQUE (installation_id);
-- Name: github_installations github_installations_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.github_installations
    ADD CONSTRAINT github_installations_pkey PRIMARY KEY (id);
-- Name: github_repositories github_repositories_installation_id_repo_id_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.github_repositories
    ADD CONSTRAINT github_repositories_installation_id_repo_id_key UNIQUE (installation_id, repo_id);
-- Name: github_repositories github_repositories_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.github_repositories
    ADD CONSTRAINT github_repositories_pkey PRIMARY KEY (id);
-- Name: hourly_usage hourly_usage_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.hourly_usage
    ADD CONSTRAINT hourly_usage_pkey PRIMARY KEY (id);
-- Name: hourly_usage hourly_usage_project_id_metric_type_hour_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.hourly_usage
    ADD CONSTRAINT hourly_usage_project_id_metric_type_hour_key UNIQUE (project_id, metric_type, hour);
-- Name: preview_access_logs preview_access_logs_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.preview_access_logs
    ADD CONSTRAINT preview_access_logs_pkey PRIMARY KEY (id);
-- Name: preview_comments preview_comments_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.preview_comments
    ADD CONSTRAINT preview_comments_pkey PRIMARY KEY (id);
-- Name: preview_environments preview_environments_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.preview_environments
    ADD CONSTRAINT preview_environments_pkey PRIMARY KEY (id);
-- Name: pricing_plans pricing_plans_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.pricing_plans
    ADD CONSTRAINT pricing_plans_pkey PRIMARY KEY (id);
-- Name: project_access project_access_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.project_access
    ADD CONSTRAINT project_access_pkey PRIMARY KEY (id);
-- Name: project_access project_access_user_id_project_id_environment_id_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.project_access
    ADD CONSTRAINT project_access_user_id_project_id_environment_id_key UNIQUE (user_id, project_id, environment_id);
-- Name: projects projects_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.projects
    ADD CONSTRAINT projects_pkey PRIMARY KEY (id);
-- Name: projects projects_slug_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.projects
    ADD CONSTRAINT projects_slug_key UNIQUE (slug);
-- Name: releases releases_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.releases
    ADD CONSTRAINT releases_pkey PRIMARY KEY (id);
-- Name: releases releases_service_id_version_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.releases
    ADD CONSTRAINT releases_service_id_version_key UNIQUE (service_id, version);
-- Name: rotation_audit_logs rotation_audit_logs_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.rotation_audit_logs
    ADD CONSTRAINT rotation_audit_logs_pkey PRIMARY KEY (id);
-- Name: routes routes_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.routes
    ADD CONSTRAINT routes_pkey PRIMARY KEY (id);
-- Name: routes routes_service_id_environment_id_path_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.routes
    ADD CONSTRAINT routes_service_id_environment_id_path_key UNIQUE (service_id, environment_id, path);
-- Name: service_dependencies service_dependencies_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.service_dependencies
    ADD CONSTRAINT service_dependencies_pkey PRIMARY KEY (id);
-- Name: services services_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.services
    ADD CONSTRAINT services_pkey PRIMARY KEY (id);
-- Name: services services_project_id_name_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.services
    ADD CONSTRAINT services_project_id_name_key UNIQUE (project_id, name);
-- Name: sessions sessions_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.sessions
    ADD CONSTRAINT sessions_pkey PRIMARY KEY (id);
-- Name: sessions sessions_token_hash_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.sessions
    ADD CONSTRAINT sessions_token_hash_key UNIQUE (token_hash);
-- Name: subscriptions subscriptions_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.subscriptions
    ADD CONSTRAINT subscriptions_pkey PRIMARY KEY (id);
-- Name: subscriptions subscriptions_project_id_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.subscriptions
    ADD CONSTRAINT subscriptions_project_id_key UNIQUE (project_id);
-- Name: team_invitations team_invitations_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.team_invitations
    ADD CONSTRAINT team_invitations_pkey PRIMARY KEY (id);
-- Name: team_invitations team_invitations_team_id_email_status_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.team_invitations
    ADD CONSTRAINT team_invitations_team_id_email_status_key UNIQUE (team_id, email, status);
-- Name: team_invitations team_invitations_token_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.team_invitations
    ADD CONSTRAINT team_invitations_token_key UNIQUE (token);
-- Name: team_members team_members_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.team_members
    ADD CONSTRAINT team_members_pkey PRIMARY KEY (id);
-- Name: team_members team_members_team_id_user_id_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.team_members
    ADD CONSTRAINT team_members_team_id_user_id_key UNIQUE (team_id, user_id);
-- Name: teams teams_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.teams
    ADD CONSTRAINT teams_pkey PRIMARY KEY (id);
-- Name: teams teams_slug_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.teams
    ADD CONSTRAINT teams_slug_key UNIQUE (slug);
-- Name: template_deployments template_deployments_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.template_deployments
    ADD CONSTRAINT template_deployments_pkey PRIMARY KEY (id);
-- Name: templates templates_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.templates
    ADD CONSTRAINT templates_pkey PRIMARY KEY (id);
-- Name: templates templates_slug_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.templates
    ADD CONSTRAINT templates_slug_key UNIQUE (slug);
-- Name: database_addons unique_addon_name_per_project; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.database_addons
    ADD CONSTRAINT unique_addon_name_per_project UNIQUE (project_id, name);
-- Name: database_addon_bindings unique_binding_per_service; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.database_addon_bindings
    ADD CONSTRAINT unique_binding_per_service UNIQUE (addon_id, service_id);
-- Name: service_dependencies unique_dependency; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.service_dependencies
    ADD CONSTRAINT unique_dependency UNIQUE (service_id, depends_on_service_id);
-- Name: environment_variables unique_env_var_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.environment_variables
    ADD CONSTRAINT unique_env_var_key UNIQUE (service_id, environment_id, key);
-- Name: function_metrics unique_function_metric_period; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.function_metrics
    ADD CONSTRAINT unique_function_metric_period UNIQUE (function_id, period, period_start);
-- Name: functions unique_function_name_per_project; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.functions
    ADD CONSTRAINT unique_function_name_per_project UNIQUE (project_id, name);
-- Name: preview_environments unique_preview_per_pr; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.preview_environments
    ADD CONSTRAINT unique_preview_per_pr UNIQUE (service_id, pr_number);
-- Name: webhook_destinations unique_webhook_name_per_project; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.webhook_destinations
    ADD CONSTRAINT unique_webhook_name_per_project UNIQUE (project_id, name);
-- Name: usage_alerts usage_alerts_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.usage_alerts
    ADD CONSTRAINT usage_alerts_pkey PRIMARY KEY (id);
-- Name: usage_alerts usage_alerts_project_id_metric_type_threshold_value_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.usage_alerts
    ADD CONSTRAINT usage_alerts_project_id_metric_type_threshold_value_key UNIQUE (project_id, metric_type, threshold_value);
-- Name: usage_events usage_events_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.usage_events
    ADD CONSTRAINT usage_events_pkey PRIMARY KEY (id);
-- Name: users users_email_key; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.users
    ADD CONSTRAINT users_email_key UNIQUE (email);
-- Name: users users_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.users
    ADD CONSTRAINT users_pkey PRIMARY KEY (id);
-- Name: webhook_deliveries webhook_deliveries_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.webhook_deliveries
    ADD CONSTRAINT webhook_deliveries_pkey PRIMARY KEY (id);
-- Name: webhook_destinations webhook_destinations_pkey; Type: CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.webhook_destinations
    ADD CONSTRAINT webhook_destinations_pkey PRIMARY KEY (id);
-- Name: idx_function_invocations_cold_start; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_function_invocations_cold_start ON ONLY public.function_invocations USING btree (cold_start) WHERE (cold_start = true);
-- Name: function_invocations_2026_01_cold_start_idx; Type: INDEX; Schema: public; Owner: -

CREATE INDEX function_invocations_2026_01_cold_start_idx ON public.function_invocations_2026_01 USING btree (cold_start) WHERE (cold_start = true);
-- Name: idx_function_invocations_function_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_function_invocations_function_id ON ONLY public.function_invocations USING btree (function_id);
-- Name: function_invocations_2026_01_function_id_idx; Type: INDEX; Schema: public; Owner: -

CREATE INDEX function_invocations_2026_01_function_id_idx ON public.function_invocations_2026_01 USING btree (function_id);
-- Name: idx_function_invocations_request_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_function_invocations_request_id ON ONLY public.function_invocations USING btree (request_id) WHERE (request_id IS NOT NULL);
-- Name: function_invocations_2026_01_request_id_idx; Type: INDEX; Schema: public; Owner: -

CREATE INDEX function_invocations_2026_01_request_id_idx ON public.function_invocations_2026_01 USING btree (request_id) WHERE (request_id IS NOT NULL);
-- Name: idx_function_invocations_started_at; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_function_invocations_started_at ON ONLY public.function_invocations USING btree (started_at);
-- Name: function_invocations_2026_01_started_at_idx; Type: INDEX; Schema: public; Owner: -

CREATE INDEX function_invocations_2026_01_started_at_idx ON public.function_invocations_2026_01 USING btree (started_at);
-- Name: function_invocations_2026_02_cold_start_idx; Type: INDEX; Schema: public; Owner: -

CREATE INDEX function_invocations_2026_02_cold_start_idx ON public.function_invocations_2026_02 USING btree (cold_start) WHERE (cold_start = true);
-- Name: function_invocations_2026_02_function_id_idx; Type: INDEX; Schema: public; Owner: -

CREATE INDEX function_invocations_2026_02_function_id_idx ON public.function_invocations_2026_02 USING btree (function_id);
-- Name: function_invocations_2026_02_request_id_idx; Type: INDEX; Schema: public; Owner: -

CREATE INDEX function_invocations_2026_02_request_id_idx ON public.function_invocations_2026_02 USING btree (request_id) WHERE (request_id IS NOT NULL);
-- Name: function_invocations_2026_02_started_at_idx; Type: INDEX; Schema: public; Owner: -

CREATE INDEX function_invocations_2026_02_started_at_idx ON public.function_invocations_2026_02 USING btree (started_at);
-- Name: function_invocations_2026_03_cold_start_idx; Type: INDEX; Schema: public; Owner: -

CREATE INDEX function_invocations_2026_03_cold_start_idx ON public.function_invocations_2026_03 USING btree (cold_start) WHERE (cold_start = true);
-- Name: function_invocations_2026_03_function_id_idx; Type: INDEX; Schema: public; Owner: -

CREATE INDEX function_invocations_2026_03_function_id_idx ON public.function_invocations_2026_03 USING btree (function_id);
-- Name: function_invocations_2026_03_request_id_idx; Type: INDEX; Schema: public; Owner: -

CREATE INDEX function_invocations_2026_03_request_id_idx ON public.function_invocations_2026_03 USING btree (request_id) WHERE (request_id IS NOT NULL);
-- Name: function_invocations_2026_03_started_at_idx; Type: INDEX; Schema: public; Owner: -

CREATE INDEX function_invocations_2026_03_started_at_idx ON public.function_invocations_2026_03 USING btree (started_at);
-- Name: function_invocations_2026_04_cold_start_idx; Type: INDEX; Schema: public; Owner: -

CREATE INDEX function_invocations_2026_04_cold_start_idx ON public.function_invocations_2026_04 USING btree (cold_start) WHERE (cold_start = true);
-- Name: function_invocations_2026_04_function_id_idx; Type: INDEX; Schema: public; Owner: -

CREATE INDEX function_invocations_2026_04_function_id_idx ON public.function_invocations_2026_04 USING btree (function_id);
-- Name: function_invocations_2026_04_request_id_idx; Type: INDEX; Schema: public; Owner: -

CREATE INDEX function_invocations_2026_04_request_id_idx ON public.function_invocations_2026_04 USING btree (request_id) WHERE (request_id IS NOT NULL);
-- Name: function_invocations_2026_04_started_at_idx; Type: INDEX; Schema: public; Owner: -

CREATE INDEX function_invocations_2026_04_started_at_idx ON public.function_invocations_2026_04 USING btree (started_at);
-- Name: function_invocations_default_cold_start_idx; Type: INDEX; Schema: public; Owner: -

CREATE INDEX function_invocations_default_cold_start_idx ON public.function_invocations_default USING btree (cold_start) WHERE (cold_start = true);
-- Name: function_invocations_default_function_id_idx; Type: INDEX; Schema: public; Owner: -

CREATE INDEX function_invocations_default_function_id_idx ON public.function_invocations_default USING btree (function_id);
-- Name: function_invocations_default_request_id_idx; Type: INDEX; Schema: public; Owner: -

CREATE INDEX function_invocations_default_request_id_idx ON public.function_invocations_default USING btree (request_id) WHERE (request_id IS NOT NULL);
-- Name: function_invocations_default_started_at_idx; Type: INDEX; Schema: public; Owner: -

CREATE INDEX function_invocations_default_started_at_idx ON public.function_invocations_default USING btree (started_at);
-- Name: idx_api_tokens_prefix; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_api_tokens_prefix ON public.api_tokens USING btree (prefix);
-- Name: idx_api_tokens_revoked; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_api_tokens_revoked ON public.api_tokens USING btree (revoked) WHERE (revoked = false);
-- Name: idx_api_tokens_token_hash; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_api_tokens_token_hash ON public.api_tokens USING btree (token_hash);
-- Name: idx_api_tokens_user_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_api_tokens_user_id ON public.api_tokens USING btree (user_id);
-- Name: idx_approval_records_deployment_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_approval_records_deployment_id ON public.approval_records USING btree (deployment_id);
-- Name: idx_audit_logs_action; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_audit_logs_action ON public.audit_logs USING btree (action);
-- Name: idx_audit_logs_actor_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_audit_logs_actor_id ON public.audit_logs USING btree (actor_id);
-- Name: idx_audit_logs_project_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_audit_logs_project_id ON public.audit_logs USING btree (project_id);
-- Name: idx_audit_logs_resource_type; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_audit_logs_resource_type ON public.audit_logs USING btree (resource_type);
-- Name: idx_audit_logs_timestamp; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_audit_logs_timestamp ON public.audit_logs USING btree ("timestamp" DESC);
-- Name: idx_billing_records_period; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_billing_records_period ON public.billing_records USING btree (period_start, period_end);
-- Name: idx_billing_records_project; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_billing_records_project ON public.billing_records USING btree (project_id);
-- Name: idx_billing_records_status; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_billing_records_status ON public.billing_records USING btree (status);
-- Name: idx_billing_records_stripe; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_billing_records_stripe ON public.billing_records USING btree (stripe_invoice_id);
-- Name: idx_build_jobs_project; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_build_jobs_project ON public.build_jobs USING btree (project_id);
-- Name: idx_build_jobs_queued_at; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_build_jobs_queued_at ON public.build_jobs USING btree (queued_at DESC);
-- Name: idx_build_jobs_release; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_build_jobs_release ON public.build_jobs USING btree (release_id);
-- Name: idx_build_jobs_service; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_build_jobs_service ON public.build_jobs USING btree (service_id);
-- Name: idx_build_jobs_status; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_build_jobs_status ON public.build_jobs USING btree (status);
-- Name: idx_build_jobs_worker; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_build_jobs_worker ON public.build_jobs USING btree (worker_id) WHERE (worker_id IS NOT NULL);
-- Name: idx_ci_runs_commit_sha; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_ci_runs_commit_sha ON public.ci_runs USING btree (commit_sha);
-- Name: idx_ci_runs_run_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_ci_runs_run_id ON public.ci_runs USING btree (run_id);
-- Name: idx_ci_runs_service_commit; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_ci_runs_service_commit ON public.ci_runs USING btree (service_id, commit_sha);
-- Name: idx_ci_runs_status; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_ci_runs_status ON public.ci_runs USING btree (status) WHERE ((status)::text <> 'completed'::text);
-- Name: idx_cloudflare_accounts_account_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_cloudflare_accounts_account_id ON public.cloudflare_accounts USING btree (account_id);
-- Name: idx_cloudflare_tunnels_cloudflare_account_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_cloudflare_tunnels_cloudflare_account_id ON public.cloudflare_tunnels USING btree (cloudflare_account_id);
-- Name: idx_cloudflare_tunnels_environment_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_cloudflare_tunnels_environment_id ON public.cloudflare_tunnels USING btree (environment_id);
-- Name: idx_credits_active; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_credits_active ON public.credits USING btree (project_id, expires_at) WHERE (used_amount < amount);
-- Name: idx_credits_project; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_credits_project ON public.credits USING btree (project_id);
-- Name: idx_custom_domains_cloudflare_tunnel_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_custom_domains_cloudflare_tunnel_id ON public.custom_domains USING btree (cloudflare_tunnel_id);
-- Name: idx_custom_domains_domain; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_custom_domains_domain ON public.custom_domains USING btree (domain);
-- Name: idx_custom_domains_environment_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_custom_domains_environment_id ON public.custom_domains USING btree (environment_id);
-- Name: idx_custom_domains_service_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_custom_domains_service_id ON public.custom_domains USING btree (service_id);
-- Name: idx_custom_domains_status; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_custom_domains_status ON public.custom_domains USING btree (status);
-- Name: idx_daily_usage_date; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_daily_usage_date ON public.daily_usage USING btree (date DESC);
-- Name: idx_daily_usage_project; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_daily_usage_project ON public.daily_usage USING btree (project_id);
-- Name: idx_database_addon_backups_addon_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_database_addon_backups_addon_id ON public.database_addon_backups USING btree (addon_id);
-- Name: idx_database_addon_backups_expires_at; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_database_addon_backups_expires_at ON public.database_addon_backups USING btree (expires_at) WHERE (expires_at IS NOT NULL);
-- Name: idx_database_addon_backups_status; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_database_addon_backups_status ON public.database_addon_backups USING btree (status);
-- Name: idx_database_addon_bindings_addon_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_database_addon_bindings_addon_id ON public.database_addon_bindings USING btree (addon_id);
-- Name: idx_database_addon_bindings_service_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_database_addon_bindings_service_id ON public.database_addon_bindings USING btree (service_id);
-- Name: idx_database_addon_bindings_status; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_database_addon_bindings_status ON public.database_addon_bindings USING btree (status) WHERE ((status)::text = 'active'::text);
-- Name: idx_database_addons_created_by; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_database_addons_created_by ON public.database_addons USING btree (created_by) WHERE (created_by IS NOT NULL);
-- Name: idx_database_addons_environment_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_database_addons_environment_id ON public.database_addons USING btree (environment_id) WHERE (environment_id IS NOT NULL);
-- Name: idx_database_addons_project_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_database_addons_project_id ON public.database_addons USING btree (project_id);
-- Name: idx_database_addons_status; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_database_addons_status ON public.database_addons USING btree (status);
-- Name: idx_database_addons_type; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_database_addons_type ON public.database_addons USING btree (type);
-- Name: idx_deployment_groups_created_at; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_deployment_groups_created_at ON public.deployment_groups USING btree (created_at DESC);
-- Name: idx_deployment_groups_environment; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_deployment_groups_environment ON public.deployment_groups USING btree (environment_id);
-- Name: idx_deployment_groups_project; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_deployment_groups_project ON public.deployment_groups USING btree (project_id);
-- Name: idx_deployment_groups_status; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_deployment_groups_status ON public.deployment_groups USING btree (status);
-- Name: idx_deployments_deploy_order; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_deployments_deploy_order ON public.deployments USING btree (group_id, deploy_order) WHERE (group_id IS NOT NULL);
-- Name: idx_deployments_environment_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_deployments_environment_id ON public.deployments USING btree (environment_id);
-- Name: idx_deployments_group; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_deployments_group ON public.deployments USING btree (group_id) WHERE (group_id IS NOT NULL);
-- Name: idx_deployments_preview; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_deployments_preview ON public.deployments USING btree (preview_environment_id) WHERE (preview_environment_id IS NOT NULL);
-- Name: idx_deployments_release_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_deployments_release_id ON public.deployments USING btree (release_id);
-- Name: idx_deployments_status_error; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_deployments_status_error ON public.deployments USING btree (status) WHERE ((status)::text = 'failed'::text);
-- Name: idx_env_var_audit_env_var; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_env_var_audit_env_var ON public.env_var_audit_logs USING btree (env_var_id);
-- Name: idx_env_var_audit_service; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_env_var_audit_service ON public.env_var_audit_logs USING btree (service_id);
-- Name: idx_env_var_audit_timestamp; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_env_var_audit_timestamp ON public.env_var_audit_logs USING btree ("timestamp");
-- Name: idx_env_vars_environment; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_env_vars_environment ON public.environment_variables USING btree (environment_id);
-- Name: idx_env_vars_key; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_env_vars_key ON public.environment_variables USING btree (key);
-- Name: idx_env_vars_service; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_env_vars_service ON public.environment_variables USING btree (service_id);
-- Name: idx_env_vars_service_env; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_env_vars_service_env ON public.environment_variables USING btree (service_id, environment_id);
-- Name: idx_environments_project_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_environments_project_id ON public.environments USING btree (project_id);
-- Name: idx_function_metrics_function_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_function_metrics_function_id ON public.function_metrics USING btree (function_id);
-- Name: idx_function_metrics_period; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_function_metrics_period ON public.function_metrics USING btree (period, period_start);
-- Name: idx_functions_created_by; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_functions_created_by ON public.functions USING btree (created_by) WHERE (created_by IS NOT NULL);
-- Name: idx_functions_deleted_at; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_functions_deleted_at ON public.functions USING btree (deleted_at) WHERE (deleted_at IS NULL);
-- Name: idx_functions_name; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_functions_name ON public.functions USING btree (name);
-- Name: idx_functions_project_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_functions_project_id ON public.functions USING btree (project_id);
-- Name: idx_functions_status; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_functions_status ON public.functions USING btree (status);
-- Name: idx_github_installations_installation_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_github_installations_installation_id ON public.github_installations USING btree (installation_id);
-- Name: idx_github_installations_user_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_github_installations_user_id ON public.github_installations USING btree (user_id);
-- Name: idx_github_repositories_repo_full_name; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_github_repositories_repo_full_name ON public.github_repositories USING btree (repo_full_name);
-- Name: idx_github_repositories_service_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_github_repositories_service_id ON public.github_repositories USING btree (service_id);
-- Name: idx_hourly_usage_hour; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_hourly_usage_hour ON public.hourly_usage USING btree (hour DESC);
-- Name: idx_hourly_usage_lookup; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_hourly_usage_lookup ON public.hourly_usage USING btree (project_id, hour, metric_type);
-- Name: idx_hourly_usage_project; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_hourly_usage_project ON public.hourly_usage USING btree (project_id);
-- Name: idx_preview_access_logs_accessed_at; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_preview_access_logs_accessed_at ON public.preview_access_logs USING btree (accessed_at DESC);
-- Name: idx_preview_access_logs_preview; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_preview_access_logs_preview ON public.preview_access_logs USING btree (preview_id);
-- Name: idx_preview_comments_preview; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_preview_comments_preview ON public.preview_comments USING btree (preview_id);
-- Name: idx_preview_comments_status; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_preview_comments_status ON public.preview_comments USING btree (status) WHERE ((status)::text = 'active'::text);
-- Name: idx_preview_comments_user; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_preview_comments_user ON public.preview_comments USING btree (user_id);
-- Name: idx_preview_environments_active; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_preview_environments_active ON public.preview_environments USING btree (status) WHERE ((status)::text = ANY ((ARRAY['active'::character varying, 'sleeping'::character varying])::text[]));
-- Name: idx_preview_environments_created_at; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_preview_environments_created_at ON public.preview_environments USING btree (created_at DESC);
-- Name: idx_preview_environments_pr; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_preview_environments_pr ON public.preview_environments USING btree (pr_number);
-- Name: idx_preview_environments_project; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_preview_environments_project ON public.preview_environments USING btree (project_id);
-- Name: idx_preview_environments_service; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_preview_environments_service ON public.preview_environments USING btree (service_id);
-- Name: idx_preview_environments_status; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_preview_environments_status ON public.preview_environments USING btree (status);
-- Name: idx_preview_environments_subdomain; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_preview_environments_subdomain ON public.preview_environments USING btree (preview_subdomain);
-- Name: idx_project_access_environment_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_project_access_environment_id ON public.project_access USING btree (environment_id);
-- Name: idx_project_access_project_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_project_access_project_id ON public.project_access USING btree (project_id);
-- Name: idx_project_access_user_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_project_access_user_id ON public.project_access USING btree (user_id);
-- Name: idx_projects_team_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_projects_team_id ON public.projects USING btree (team_id);
-- Name: idx_releases_service_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_releases_service_id ON public.releases USING btree (service_id);
-- Name: idx_releases_status_error; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_releases_status_error ON public.releases USING btree (status) WHERE ((status)::text = 'failed'::text);
-- Name: idx_rotation_audit_logs_event_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_rotation_audit_logs_event_id ON public.rotation_audit_logs USING btree (event_id);
-- Name: idx_rotation_audit_logs_service_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_rotation_audit_logs_service_id ON public.rotation_audit_logs USING btree (service_id);
-- Name: idx_rotation_audit_logs_service_started; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_rotation_audit_logs_service_started ON public.rotation_audit_logs USING btree (service_id, started_at DESC);
-- Name: idx_rotation_audit_logs_started_at; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_rotation_audit_logs_started_at ON public.rotation_audit_logs USING btree (started_at DESC);
-- Name: idx_rotation_audit_logs_status; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_rotation_audit_logs_status ON public.rotation_audit_logs USING btree (status);
-- Name: idx_routes_environment_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_routes_environment_id ON public.routes USING btree (environment_id);
-- Name: idx_routes_service_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_routes_service_id ON public.routes USING btree (service_id);
-- Name: idx_service_dependencies_depends_on; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_service_dependencies_depends_on ON public.service_dependencies USING btree (depends_on_service_id);
-- Name: idx_service_dependencies_service; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_service_dependencies_service ON public.service_dependencies USING btree (service_id);
-- Name: idx_services_auto_deploy; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_services_auto_deploy ON public.services USING btree (auto_deploy) WHERE (auto_deploy = true);
-- Name: idx_services_git_repo_app_path; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_services_git_repo_app_path ON public.services USING btree (git_repo, app_path);
-- Name: idx_services_project_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_services_project_id ON public.services USING btree (project_id);
-- Name: idx_services_health; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_services_health ON public.services USING btree (health);
-- Name: idx_services_status; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_services_status ON public.services USING btree (status);
-- Name: idx_sessions_expires_at; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_sessions_expires_at ON public.sessions USING btree (expires_at);
-- Name: idx_sessions_token_hash; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_sessions_token_hash ON public.sessions USING btree (token_hash);
-- Name: idx_sessions_user_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_sessions_user_id ON public.sessions USING btree (user_id);
-- Name: idx_subscriptions_status; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_subscriptions_status ON public.subscriptions USING btree (status);
-- Name: idx_subscriptions_stripe; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_subscriptions_stripe ON public.subscriptions USING btree (stripe_customer_id);
-- Name: idx_team_invitations_email; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_team_invitations_email ON public.team_invitations USING btree (email);
-- Name: idx_team_invitations_expires_at; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_team_invitations_expires_at ON public.team_invitations USING btree (expires_at);
-- Name: idx_team_invitations_status; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_team_invitations_status ON public.team_invitations USING btree (status);
-- Name: idx_team_invitations_team_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_team_invitations_team_id ON public.team_invitations USING btree (team_id);
-- Name: idx_team_invitations_token; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_team_invitations_token ON public.team_invitations USING btree (token);
-- Name: idx_team_members_team_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_team_members_team_id ON public.team_members USING btree (team_id);
-- Name: idx_team_members_user_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_team_members_user_id ON public.team_members USING btree (user_id);
-- Name: idx_teams_owner_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_teams_owner_id ON public.teams USING btree (owner_id);
-- Name: idx_template_deployments_project; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_template_deployments_project ON public.template_deployments USING btree (project_id);
-- Name: idx_template_deployments_template; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_template_deployments_template ON public.template_deployments USING btree (template_id);
-- Name: idx_template_deployments_user; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_template_deployments_user ON public.template_deployments USING btree (user_id);
-- Name: idx_templates_category; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_templates_category ON public.templates USING btree (category);
-- Name: idx_templates_deploy_count; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_templates_deploy_count ON public.templates USING btree (deploy_count DESC);
-- Name: idx_templates_framework; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_templates_framework ON public.templates USING btree (framework);
-- Name: idx_templates_is_featured; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_templates_is_featured ON public.templates USING btree (is_featured) WHERE (is_featured = true);
-- Name: idx_templates_is_official; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_templates_is_official ON public.templates USING btree (is_official) WHERE (is_official = true);
-- Name: idx_templates_language; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_templates_language ON public.templates USING btree (language);
-- Name: idx_templates_slug; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_templates_slug ON public.templates USING btree (slug);
-- Name: idx_usage_events_project; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_usage_events_project ON public.usage_events USING btree (project_id);
-- Name: idx_usage_events_resource; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_usage_events_resource ON public.usage_events USING btree (resource_type, resource_id);
-- Name: idx_usage_events_timestamp; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_usage_events_timestamp ON public.usage_events USING btree ("timestamp" DESC);
-- Name: idx_usage_events_type; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_usage_events_type ON public.usage_events USING btree (event_type);
-- Name: idx_usage_events_unprocessed; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_usage_events_unprocessed ON public.usage_events USING btree ("timestamp") WHERE (processed_at IS NULL);
-- Name: idx_users_email; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_users_email ON public.users USING btree (email);
-- Name: idx_users_oidc_identity; Type: INDEX; Schema: public; Owner: -

CREATE UNIQUE INDEX idx_users_oidc_identity ON public.users USING btree (oidc_issuer, oidc_subject) WHERE ((oidc_issuer IS NOT NULL) AND (oidc_subject IS NOT NULL));
-- Name: idx_users_oidc_subject; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_users_oidc_subject ON public.users USING btree (oidc_subject);
-- Name: idx_webhook_deliveries_attempted_at; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_webhook_deliveries_attempted_at ON public.webhook_deliveries USING btree (attempted_at);
-- Name: idx_webhook_deliveries_event_type; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_webhook_deliveries_event_type ON public.webhook_deliveries USING btree (event_type);
-- Name: idx_webhook_deliveries_status; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_webhook_deliveries_status ON public.webhook_deliveries USING btree (status);
-- Name: idx_webhook_deliveries_webhook_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_webhook_deliveries_webhook_id ON public.webhook_deliveries USING btree (webhook_id);
-- Name: idx_webhook_destinations_enabled; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_webhook_destinations_enabled ON public.webhook_destinations USING btree (enabled) WHERE (enabled = true);
-- Name: idx_webhook_destinations_project_id; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_webhook_destinations_project_id ON public.webhook_destinations USING btree (project_id);
-- Name: idx_webhook_destinations_type; Type: INDEX; Schema: public; Owner: -

CREATE INDEX idx_webhook_destinations_type ON public.webhook_destinations USING btree (type);
-- Name: function_invocations_2026_01_cold_start_idx; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.idx_function_invocations_cold_start ATTACH PARTITION public.function_invocations_2026_01_cold_start_idx;
-- Name: function_invocations_2026_01_function_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.idx_function_invocations_function_id ATTACH PARTITION public.function_invocations_2026_01_function_id_idx;
-- Name: function_invocations_2026_01_pkey; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.function_invocations_pkey ATTACH PARTITION public.function_invocations_2026_01_pkey;
-- Name: function_invocations_2026_01_request_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.idx_function_invocations_request_id ATTACH PARTITION public.function_invocations_2026_01_request_id_idx;
-- Name: function_invocations_2026_01_started_at_idx; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.idx_function_invocations_started_at ATTACH PARTITION public.function_invocations_2026_01_started_at_idx;
-- Name: function_invocations_2026_02_cold_start_idx; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.idx_function_invocations_cold_start ATTACH PARTITION public.function_invocations_2026_02_cold_start_idx;
-- Name: function_invocations_2026_02_function_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.idx_function_invocations_function_id ATTACH PARTITION public.function_invocations_2026_02_function_id_idx;
-- Name: function_invocations_2026_02_pkey; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.function_invocations_pkey ATTACH PARTITION public.function_invocations_2026_02_pkey;
-- Name: function_invocations_2026_02_request_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.idx_function_invocations_request_id ATTACH PARTITION public.function_invocations_2026_02_request_id_idx;
-- Name: function_invocations_2026_02_started_at_idx; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.idx_function_invocations_started_at ATTACH PARTITION public.function_invocations_2026_02_started_at_idx;
-- Name: function_invocations_2026_03_cold_start_idx; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.idx_function_invocations_cold_start ATTACH PARTITION public.function_invocations_2026_03_cold_start_idx;
-- Name: function_invocations_2026_03_function_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.idx_function_invocations_function_id ATTACH PARTITION public.function_invocations_2026_03_function_id_idx;
-- Name: function_invocations_2026_03_pkey; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.function_invocations_pkey ATTACH PARTITION public.function_invocations_2026_03_pkey;
-- Name: function_invocations_2026_03_request_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.idx_function_invocations_request_id ATTACH PARTITION public.function_invocations_2026_03_request_id_idx;
-- Name: function_invocations_2026_03_started_at_idx; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.idx_function_invocations_started_at ATTACH PARTITION public.function_invocations_2026_03_started_at_idx;
-- Name: function_invocations_2026_04_cold_start_idx; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.idx_function_invocations_cold_start ATTACH PARTITION public.function_invocations_2026_04_cold_start_idx;
-- Name: function_invocations_2026_04_function_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.idx_function_invocations_function_id ATTACH PARTITION public.function_invocations_2026_04_function_id_idx;
-- Name: function_invocations_2026_04_pkey; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.function_invocations_pkey ATTACH PARTITION public.function_invocations_2026_04_pkey;
-- Name: function_invocations_2026_04_request_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.idx_function_invocations_request_id ATTACH PARTITION public.function_invocations_2026_04_request_id_idx;
-- Name: function_invocations_2026_04_started_at_idx; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.idx_function_invocations_started_at ATTACH PARTITION public.function_invocations_2026_04_started_at_idx;
-- Name: function_invocations_default_cold_start_idx; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.idx_function_invocations_cold_start ATTACH PARTITION public.function_invocations_default_cold_start_idx;
-- Name: function_invocations_default_function_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.idx_function_invocations_function_id ATTACH PARTITION public.function_invocations_default_function_id_idx;
-- Name: function_invocations_default_pkey; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.function_invocations_pkey ATTACH PARTITION public.function_invocations_default_pkey;
-- Name: function_invocations_default_request_id_idx; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.idx_function_invocations_request_id ATTACH PARTITION public.function_invocations_default_request_id_idx;
-- Name: function_invocations_default_started_at_idx; Type: INDEX ATTACH; Schema: public; Owner: -

ALTER INDEX public.idx_function_invocations_started_at ATTACH PARTITION public.function_invocations_default_started_at_idx;
-- Name: billing_records billing_records_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER billing_records_updated_at BEFORE UPDATE ON public.billing_records FOR EACH ROW EXECUTE FUNCTION public.update_waybill_updated_at();
-- Name: build_jobs build_jobs_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER build_jobs_updated_at BEFORE UPDATE ON public.build_jobs FOR EACH ROW EXECUTE FUNCTION public.update_build_jobs_updated_at();
-- Name: pricing_plans pricing_plans_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER pricing_plans_updated_at BEFORE UPDATE ON public.pricing_plans FOR EACH ROW EXECUTE FUNCTION public.update_waybill_updated_at();
-- Name: subscriptions subscriptions_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER subscriptions_updated_at BEFORE UPDATE ON public.subscriptions FOR EACH ROW EXECUTE FUNCTION public.update_waybill_updated_at();
-- Name: environment_variables trigger_env_var_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER trigger_env_var_updated_at BEFORE UPDATE ON public.environment_variables FOR EACH ROW EXECUTE FUNCTION public.update_env_var_updated_at();
-- Name: github_installations trigger_github_installations_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER trigger_github_installations_updated_at BEFORE UPDATE ON public.github_installations FOR EACH ROW EXECUTE FUNCTION public.update_github_installations_updated_at();
-- Name: github_repositories trigger_github_repositories_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER trigger_github_repositories_updated_at BEFORE UPDATE ON public.github_repositories FOR EACH ROW EXECUTE FUNCTION public.update_github_repositories_updated_at();
-- Name: template_deployments trigger_increment_deploy_count; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER trigger_increment_deploy_count AFTER INSERT OR UPDATE ON public.template_deployments FOR EACH ROW EXECUTE FUNCTION public.increment_template_deploy_count();
-- Name: api_tokens trigger_update_api_tokens_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER trigger_update_api_tokens_updated_at BEFORE UPDATE ON public.api_tokens FOR EACH ROW EXECUTE FUNCTION public.update_api_tokens_updated_at();
-- Name: database_addon_bindings trigger_update_database_addon_bindings_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER trigger_update_database_addon_bindings_updated_at BEFORE UPDATE ON public.database_addon_bindings FOR EACH ROW EXECUTE FUNCTION public.update_database_addons_updated_at();
-- Name: database_addons trigger_update_database_addons_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER trigger_update_database_addons_updated_at BEFORE UPDATE ON public.database_addons FOR EACH ROW EXECUTE FUNCTION public.update_database_addons_updated_at();
-- Name: functions trigger_update_functions_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER trigger_update_functions_updated_at BEFORE UPDATE ON public.functions FOR EACH ROW EXECUTE FUNCTION public.update_functions_updated_at();
-- Name: team_invitations trigger_update_team_invitations_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER trigger_update_team_invitations_updated_at BEFORE UPDATE ON public.team_invitations FOR EACH ROW EXECUTE FUNCTION public.update_team_invitations_updated_at();
-- Name: webhook_destinations trigger_update_webhook_destinations_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER trigger_update_webhook_destinations_updated_at BEFORE UPDATE ON public.webhook_destinations FOR EACH ROW EXECUTE FUNCTION public.update_webhook_destinations_updated_at();
-- Name: cloudflare_accounts update_cloudflare_accounts_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER update_cloudflare_accounts_updated_at BEFORE UPDATE ON public.cloudflare_accounts FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
-- Name: cloudflare_tunnels update_cloudflare_tunnels_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER update_cloudflare_tunnels_updated_at BEFORE UPDATE ON public.cloudflare_tunnels FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
-- Name: deployment_groups update_deployment_groups_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER update_deployment_groups_updated_at BEFORE UPDATE ON public.deployment_groups FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
-- Name: deployments update_deployments_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER update_deployments_updated_at BEFORE UPDATE ON public.deployments FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
-- Name: environments update_environments_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER update_environments_updated_at BEFORE UPDATE ON public.environments FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
-- Name: preview_comments update_preview_comments_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER update_preview_comments_updated_at BEFORE UPDATE ON public.preview_comments FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
-- Name: preview_environments update_preview_environments_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER update_preview_environments_updated_at BEFORE UPDATE ON public.preview_environments FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
-- Name: projects update_projects_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER update_projects_updated_at BEFORE UPDATE ON public.projects FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
-- Name: releases update_releases_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER update_releases_updated_at BEFORE UPDATE ON public.releases FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
-- Name: services update_services_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER update_services_updated_at BEFORE UPDATE ON public.services FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
-- Name: teams update_teams_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER update_teams_updated_at BEFORE UPDATE ON public.teams FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
-- Name: users update_users_updated_at; Type: TRIGGER; Schema: public; Owner: -

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON public.users FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
-- Name: api_tokens api_tokens_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.api_tokens
    ADD CONSTRAINT api_tokens_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;
-- Name: approval_records approval_records_deployment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.approval_records
    ADD CONSTRAINT approval_records_deployment_id_fkey FOREIGN KEY (deployment_id) REFERENCES public.deployments(id) ON DELETE CASCADE;
-- Name: audit_logs audit_logs_actor_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.audit_logs
    ADD CONSTRAINT audit_logs_actor_id_fkey FOREIGN KEY (actor_id) REFERENCES public.users(id);
-- Name: audit_logs audit_logs_environment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.audit_logs
    ADD CONSTRAINT audit_logs_environment_id_fkey FOREIGN KEY (environment_id) REFERENCES public.environments(id) ON DELETE SET NULL;
-- Name: audit_logs audit_logs_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.audit_logs
    ADD CONSTRAINT audit_logs_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE SET NULL;
-- Name: billing_records billing_records_plan_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.billing_records
    ADD CONSTRAINT billing_records_plan_id_fkey FOREIGN KEY (plan_id) REFERENCES public.pricing_plans(id);
-- Name: billing_records billing_records_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.billing_records
    ADD CONSTRAINT billing_records_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;
-- Name: billing_records billing_records_subscription_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.billing_records
    ADD CONSTRAINT billing_records_subscription_id_fkey FOREIGN KEY (subscription_id) REFERENCES public.subscriptions(id) ON DELETE SET NULL;
-- Name: build_jobs build_jobs_parent_job_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.build_jobs
    ADD CONSTRAINT build_jobs_parent_job_id_fkey FOREIGN KEY (parent_job_id) REFERENCES public.build_jobs(id);
-- Name: build_jobs build_jobs_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.build_jobs
    ADD CONSTRAINT build_jobs_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;
-- Name: build_jobs build_jobs_release_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.build_jobs
    ADD CONSTRAINT build_jobs_release_id_fkey FOREIGN KEY (release_id) REFERENCES public.releases(id) ON DELETE CASCADE;
-- Name: build_jobs build_jobs_service_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.build_jobs
    ADD CONSTRAINT build_jobs_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services(id) ON DELETE CASCADE;
-- Name: ci_runs ci_runs_service_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.ci_runs
    ADD CONSTRAINT ci_runs_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services(id) ON DELETE CASCADE;
-- Name: cloudflare_tunnels cloudflare_tunnels_cloudflare_account_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.cloudflare_tunnels
    ADD CONSTRAINT cloudflare_tunnels_cloudflare_account_id_fkey FOREIGN KEY (cloudflare_account_id) REFERENCES public.cloudflare_accounts(id) ON DELETE CASCADE;
-- Name: cloudflare_tunnels cloudflare_tunnels_environment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.cloudflare_tunnels
    ADD CONSTRAINT cloudflare_tunnels_environment_id_fkey FOREIGN KEY (environment_id) REFERENCES public.environments(id) ON DELETE CASCADE;
-- Name: credits credits_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.credits
    ADD CONSTRAINT credits_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;
-- Name: custom_domains custom_domains_cloudflare_tunnel_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.custom_domains
    ADD CONSTRAINT custom_domains_cloudflare_tunnel_id_fkey FOREIGN KEY (cloudflare_tunnel_id) REFERENCES public.cloudflare_tunnels(id);
-- Name: custom_domains custom_domains_environment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.custom_domains
    ADD CONSTRAINT custom_domains_environment_id_fkey FOREIGN KEY (environment_id) REFERENCES public.environments(id) ON DELETE CASCADE;
-- Name: custom_domains custom_domains_service_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.custom_domains
    ADD CONSTRAINT custom_domains_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services(id) ON DELETE CASCADE;
-- Name: daily_usage daily_usage_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.daily_usage
    ADD CONSTRAINT daily_usage_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;
-- Name: database_addon_backups database_addon_backups_addon_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.database_addon_backups
    ADD CONSTRAINT database_addon_backups_addon_id_fkey FOREIGN KEY (addon_id) REFERENCES public.database_addons(id) ON DELETE CASCADE;
-- Name: database_addon_bindings database_addon_bindings_addon_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.database_addon_bindings
    ADD CONSTRAINT database_addon_bindings_addon_id_fkey FOREIGN KEY (addon_id) REFERENCES public.database_addons(id) ON DELETE CASCADE;
-- Name: database_addon_bindings database_addon_bindings_service_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.database_addon_bindings
    ADD CONSTRAINT database_addon_bindings_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services(id) ON DELETE CASCADE;
-- Name: database_addons database_addons_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.database_addons
    ADD CONSTRAINT database_addons_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id);
-- Name: database_addons database_addons_environment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.database_addons
    ADD CONSTRAINT database_addons_environment_id_fkey FOREIGN KEY (environment_id) REFERENCES public.environments(id) ON DELETE SET NULL;
-- Name: database_addons database_addons_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.database_addons
    ADD CONSTRAINT database_addons_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;
-- Name: deployment_groups deployment_groups_environment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.deployment_groups
    ADD CONSTRAINT deployment_groups_environment_id_fkey FOREIGN KEY (environment_id) REFERENCES public.environments(id) ON DELETE CASCADE;
-- Name: deployment_groups deployment_groups_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.deployment_groups
    ADD CONSTRAINT deployment_groups_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;
-- Name: deployments deployments_environment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.deployments
    ADD CONSTRAINT deployments_environment_id_fkey FOREIGN KEY (environment_id) REFERENCES public.environments(id) ON DELETE CASCADE;
-- Name: deployments deployments_group_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.deployments
    ADD CONSTRAINT deployments_group_id_fkey FOREIGN KEY (group_id) REFERENCES public.deployment_groups(id) ON DELETE SET NULL;
-- Name: deployments deployments_preview_environment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.deployments
    ADD CONSTRAINT deployments_preview_environment_id_fkey FOREIGN KEY (preview_environment_id) REFERENCES public.preview_environments(id) ON DELETE SET NULL;
-- Name: deployments deployments_release_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.deployments
    ADD CONSTRAINT deployments_release_id_fkey FOREIGN KEY (release_id) REFERENCES public.releases(id) ON DELETE CASCADE;
-- Name: environment_variables environment_variables_environment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.environment_variables
    ADD CONSTRAINT environment_variables_environment_id_fkey FOREIGN KEY (environment_id) REFERENCES public.environments(id) ON DELETE CASCADE;
-- Name: environment_variables environment_variables_service_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.environment_variables
    ADD CONSTRAINT environment_variables_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services(id) ON DELETE CASCADE;
-- Name: environments environments_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.environments
    ADD CONSTRAINT environments_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;
-- Name: function_metrics function_metrics_function_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.function_metrics
    ADD CONSTRAINT function_metrics_function_id_fkey FOREIGN KEY (function_id) REFERENCES public.functions(id) ON DELETE CASCADE;
-- Name: functions functions_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.functions
    ADD CONSTRAINT functions_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id);
-- Name: functions functions_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.functions
    ADD CONSTRAINT functions_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;
-- Name: github_installations github_installations_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.github_installations
    ADD CONSTRAINT github_installations_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;
-- Name: github_repositories github_repositories_installation_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.github_repositories
    ADD CONSTRAINT github_repositories_installation_id_fkey FOREIGN KEY (installation_id) REFERENCES public.github_installations(id) ON DELETE CASCADE;
-- Name: github_repositories github_repositories_service_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.github_repositories
    ADD CONSTRAINT github_repositories_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services(id) ON DELETE SET NULL;
-- Name: hourly_usage hourly_usage_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.hourly_usage
    ADD CONSTRAINT hourly_usage_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;
-- Name: preview_access_logs preview_access_logs_preview_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.preview_access_logs
    ADD CONSTRAINT preview_access_logs_preview_id_fkey FOREIGN KEY (preview_id) REFERENCES public.preview_environments(id) ON DELETE CASCADE;
-- Name: preview_comments preview_comments_preview_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.preview_comments
    ADD CONSTRAINT preview_comments_preview_id_fkey FOREIGN KEY (preview_id) REFERENCES public.preview_environments(id) ON DELETE CASCADE;
-- Name: preview_environments preview_environments_deployment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.preview_environments
    ADD CONSTRAINT preview_environments_deployment_id_fkey FOREIGN KEY (deployment_id) REFERENCES public.deployments(id) ON DELETE SET NULL;
-- Name: preview_environments preview_environments_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.preview_environments
    ADD CONSTRAINT preview_environments_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;
-- Name: preview_environments preview_environments_service_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.preview_environments
    ADD CONSTRAINT preview_environments_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services(id) ON DELETE CASCADE;
-- Name: project_access project_access_environment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.project_access
    ADD CONSTRAINT project_access_environment_id_fkey FOREIGN KEY (environment_id) REFERENCES public.environments(id) ON DELETE CASCADE;
-- Name: project_access project_access_granted_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.project_access
    ADD CONSTRAINT project_access_granted_by_fkey FOREIGN KEY (granted_by) REFERENCES public.users(id);
-- Name: project_access project_access_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.project_access
    ADD CONSTRAINT project_access_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;
-- Name: project_access project_access_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.project_access
    ADD CONSTRAINT project_access_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;
-- Name: projects projects_team_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.projects
    ADD CONSTRAINT projects_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(id) ON DELETE SET NULL;
-- Name: releases releases_service_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.releases
    ADD CONSTRAINT releases_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services(id) ON DELETE CASCADE;
-- Name: rotation_audit_logs rotation_audit_logs_service_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.rotation_audit_logs
    ADD CONSTRAINT rotation_audit_logs_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services(id) ON DELETE CASCADE;
-- Name: routes routes_environment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.routes
    ADD CONSTRAINT routes_environment_id_fkey FOREIGN KEY (environment_id) REFERENCES public.environments(id) ON DELETE CASCADE;
-- Name: routes routes_service_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.routes
    ADD CONSTRAINT routes_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services(id) ON DELETE CASCADE;
-- Name: service_dependencies service_dependencies_depends_on_service_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.service_dependencies
    ADD CONSTRAINT service_dependencies_depends_on_service_id_fkey FOREIGN KEY (depends_on_service_id) REFERENCES public.services(id) ON DELETE CASCADE;
-- Name: service_dependencies service_dependencies_service_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.service_dependencies
    ADD CONSTRAINT service_dependencies_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.services(id) ON DELETE CASCADE;
-- Name: services services_github_repo_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.services
    ADD CONSTRAINT services_github_repo_id_fkey FOREIGN KEY (github_repo_id) REFERENCES public.github_repositories(id) ON DELETE SET NULL;
-- Name: services services_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.services
    ADD CONSTRAINT services_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;
-- Name: sessions sessions_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.sessions
    ADD CONSTRAINT sessions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;
-- Name: subscriptions subscriptions_plan_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.subscriptions
    ADD CONSTRAINT subscriptions_plan_id_fkey FOREIGN KEY (plan_id) REFERENCES public.pricing_plans(id);
-- Name: subscriptions subscriptions_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.subscriptions
    ADD CONSTRAINT subscriptions_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;
-- Name: subscriptions subscriptions_team_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.subscriptions
    ADD CONSTRAINT subscriptions_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(id) ON DELETE SET NULL;
-- Name: team_invitations team_invitations_invited_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.team_invitations
    ADD CONSTRAINT team_invitations_invited_by_fkey FOREIGN KEY (invited_by) REFERENCES public.users(id);
-- Name: team_invitations team_invitations_team_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.team_invitations
    ADD CONSTRAINT team_invitations_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(id) ON DELETE CASCADE;
-- Name: team_members team_members_invited_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.team_members
    ADD CONSTRAINT team_members_invited_by_fkey FOREIGN KEY (invited_by) REFERENCES public.users(id);
-- Name: team_members team_members_team_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.team_members
    ADD CONSTRAINT team_members_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(id) ON DELETE CASCADE;
-- Name: team_members team_members_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.team_members
    ADD CONSTRAINT team_members_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;
-- Name: teams teams_owner_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.teams
    ADD CONSTRAINT teams_owner_id_fkey FOREIGN KEY (owner_id) REFERENCES public.users(id);
-- Name: template_deployments template_deployments_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.template_deployments
    ADD CONSTRAINT template_deployments_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;
-- Name: template_deployments template_deployments_template_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.template_deployments
    ADD CONSTRAINT template_deployments_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.templates(id) ON DELETE CASCADE;
-- Name: template_deployments template_deployments_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.template_deployments
    ADD CONSTRAINT template_deployments_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE SET NULL;
-- Name: usage_alerts usage_alerts_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.usage_alerts
    ADD CONSTRAINT usage_alerts_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;
-- Name: usage_events usage_events_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.usage_events
    ADD CONSTRAINT usage_events_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;
-- Name: usage_events usage_events_team_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.usage_events
    ADD CONSTRAINT usage_events_team_id_fkey FOREIGN KEY (team_id) REFERENCES public.teams(id) ON DELETE SET NULL;
-- Name: webhook_deliveries webhook_deliveries_webhook_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.webhook_deliveries
    ADD CONSTRAINT webhook_deliveries_webhook_id_fkey FOREIGN KEY (webhook_id) REFERENCES public.webhook_destinations(id) ON DELETE CASCADE;
-- Name: webhook_destinations webhook_destinations_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.webhook_destinations
    ADD CONSTRAINT webhook_destinations_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id);
-- Name: webhook_destinations webhook_destinations_project_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -

ALTER TABLE ONLY public.webhook_destinations
    ADD CONSTRAINT webhook_destinations_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id) ON DELETE CASCADE;
-- Name: audit_logs audit_log_allow_insert; Type: POLICY; Schema: public; Owner: -

CREATE POLICY audit_log_allow_insert ON public.audit_logs FOR INSERT WITH CHECK (true);
-- Name: audit_logs audit_log_allow_select; Type: POLICY; Schema: public; Owner: -

CREATE POLICY audit_log_allow_select ON public.audit_logs FOR SELECT USING (true);
-- Name: audit_logs audit_log_immutable_delete; Type: POLICY; Schema: public; Owner: -

CREATE POLICY audit_log_immutable_delete ON public.audit_logs FOR DELETE USING (false);
-- Name: audit_logs audit_log_immutable_update; Type: POLICY; Schema: public; Owner: -

CREATE POLICY audit_log_immutable_update ON public.audit_logs FOR UPDATE USING (false);
-- Name: audit_logs; Type: ROW SECURITY; Schema: public; Owner: -

ALTER TABLE public.audit_logs ENABLE ROW LEVEL SECURITY;


