# Enclii Code Guidelines

## Project Context
Enclii is a Railway-style PaaS running on Hetzner + Cloudflare (~$100/month).
Authenticated via Janua SSO (OIDC/RS256). Production services at enclii.dev.

## Architecture
- **Switchyard**: Control plane API (Go + Gin)
- **Conductor**: CLI (`enclii` command, Go + Cobra)
- **Roundhouse**: Build worker (Go)
- **UI**: Next.js 14 (App Router)
- **Infra**: K3s on Hetzner, Cloudflare Tunnel ingress

## Code Style

### Go
- Standard `go fmt` formatting
- `golangci-lint` for static analysis
- Error wrapping: `fmt.Errorf("context: %w", err)`
- Structured logging: `log.Info("action", "key", value)`
- Tests in `*_test.go` files alongside source

### TypeScript/React
- ESLint + Prettier
- Prefer `interface` over `type` for objects
- Use React Server Components where possible
- Tailwind CSS for styling

### General
- Conventional commits: `feat:`, `fix:`, `docs:`, `chore:`
- Never commit secrets (use Lockbox/Vault)
- All images must be signed with cosign

## File Locations
```
apps/switchyard-api/internal/api/    # HTTP handlers
apps/switchyard-api/internal/service/ # Business logic
apps/switchyard-api/internal/models/  # Data models
packages/cli/internal/cmd/            # CLI commands
apps/switchyard-ui/app/               # Next.js routes
apps/switchyard-ui/components/        # React components
infra/k8s/production/                 # K8s manifests
docs/                                 # Documentation
```

## Port Allocation
- API: 4200 (api.enclii.dev)
- UI: 4201 (app.enclii.dev)
- Docs: 4203 (docs.enclii.dev)

## Common Patterns

### API Handler
```go
func (h *Handlers) CreateResource(c *gin.Context) {
    var req CreateResourceRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        c.JSON(400, gin.H{"error": err.Error()})
        return
    }

    resource, err := h.service.Create(c.Request.Context(), req)
    if err != nil {
        c.JSON(500, gin.H{"error": err.Error()})
        return
    }

    c.JSON(201, resource)
}
```

### CLI Command
```go
var resourceCmd = &cobra.Command{
    Use:   "resource",
    Short: "Manage resources",
    RunE: func(cmd *cobra.Command, args []string) error {
        client := api.NewClient(cfg)
        return client.ListResources(cmd.Context())
    },
}
```

### React Component
```tsx
export function ResourceCard({ resource }: { resource: Resource }) {
  return (
    <Card>
      <CardHeader>
        <CardTitle>{resource.name}</CardTitle>
      </CardHeader>
      <CardContent>
        <Badge variant={resource.status}>{resource.status}</Badge>
      </CardContent>
    </Card>
  );
}
```

## Testing
- Unit tests: `make test`
- Integration: `make integration-test`
- E2E: `make e2e`

## Before Committing
```bash
make lint && make test && make precommit
```

## Key Commands
```bash
make run-switchyard    # API on :4200
make run-ui            # UI on :3000
./bin/enclii deploy    # Deploy service
./bin/enclii logs -f   # Stream logs
```
