# Janua Landing Page Service Specification
# Marketing and landing page for Janua
#
# Repository: https://github.com/madfam-io/janua
# Path: apps/landing
# Port: 3001 (per PORT_REGISTRY.md)

apiVersion: enclii.io/v1
kind: Service
metadata:
  name: janua-landing
  namespace: enclii-platform
  labels:
    app: janua-landing
    tier: frontend
    criticality: medium
  annotations:
    enclii.dev/description: "Janua marketing and landing page"
    enclii.dev/owner: platform-team

spec:
  # ==========================================================================
  # SOURCE CONFIGURATION
  # ==========================================================================
  source:
    git:
      repository: https://github.com/madfam-io/janua
      branch: main
      path: apps/landing

    build:
      type: dockerfile
      dockerfile: apps/landing/Dockerfile
      context: .
      args:
        - name: NODE_ENV
          value: production

      provenance:
        enabled: true
        sbom: true

  # ==========================================================================
  # DEPLOYMENT CONFIGURATION
  # ==========================================================================
  deployment:
    replicas: 2

    strategy:
      type: RollingUpdate
      rollingUpdate:
        maxSurge: 1
        maxUnavailable: 1

    container:
      port: 3000

      healthCheck:
        path: /
        port: 3000
        initialDelaySeconds: 10
        periodSeconds: 15
        timeoutSeconds: 5
        failureThreshold: 3

      resources:
        requests:
          cpu: "50m"
          memory: "64Mi"
        limits:
          cpu: "200m"
          memory: "256Mi"

      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        readOnlyRootFilesystem: true
        allowPrivilegeEscalation: false

  # ==========================================================================
  # AUTOSCALING
  # ==========================================================================
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 4
    metrics:
      - type: Resource
        resource:
          name: cpu
          target:
            type: Utilization
            averageUtilization: 80

  # ==========================================================================
  # NETWORKING
  # ==========================================================================
  networking:
    domains:
      - name: janua.dev
        primary: true
        tls:
          enabled: true
          provider: cloudflare
      - name: www.janua.dev
        tls:
          enabled: true
          provider: cloudflare

    service:
      type: ClusterIP
      port: 3001  # External port per PORT_REGISTRY
      targetPort: 3000

    ingress:
      enabled: true

  # ==========================================================================
  # ENVIRONMENT CONFIGURATION
  # ==========================================================================
  env:
    - name: NODE_ENV
      value: production

    - name: PORT
      value: "3000"

    - name: NEXT_PUBLIC_API_URL
      value: "https://api.janua.dev"

    - name: NEXT_PUBLIC_APP_URL
      value: "https://app.janua.dev"

  # ==========================================================================
  # DEPLOYMENT PIPELINE
  # ==========================================================================
  pipeline:
    autoDeploy: true

    stages:
      - name: build
        timeout: 300

      - name: deploy-production
        strategy: rolling
        rollbackOnFailure: true
