# Janua Dashboard Service Specification
# User management and authentication dashboard UI
#
# Repository: https://github.com/madfam-io/janua
# Path: apps/dashboard
# Port: 3002 (per PORT_REGISTRY.md)

apiVersion: enclii.io/v1
kind: Service
metadata:
  name: janua-dashboard
  namespace: enclii-platform
  labels:
    app: janua-dashboard
    tier: frontend
    criticality: high
  annotations:
    enclii.dev/description: "Janua authentication dashboard and admin UI"
    enclii.dev/owner: platform-team

spec:
  # ==========================================================================
  # SOURCE CONFIGURATION
  # ==========================================================================
  source:
    git:
      repository: https://github.com/madfam-io/janua
      branch: main
      path: apps/dashboard

    build:
      type: dockerfile
      dockerfile: apps/dashboard/Dockerfile
      context: .
      args:
        - name: NODE_ENV
          value: production

      provenance:
        enabled: true
        sbom: true
        signing: true

  # ==========================================================================
  # DEPLOYMENT CONFIGURATION
  # ==========================================================================
  deployment:
    replicas: 2

    strategy:
      type: RollingUpdate
      rollingUpdate:
        maxSurge: 1
        maxUnavailable: 0

    container:
      port: 3000  # Internal container port (Next.js default)

      healthCheck:
        path: /api/health
        port: 3000
        initialDelaySeconds: 15
        periodSeconds: 10
        timeoutSeconds: 5
        failureThreshold: 3

      resources:
        requests:
          cpu: "100m"
          memory: "128Mi"
        limits:
          cpu: "500m"
          memory: "512Mi"

      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        readOnlyRootFilesystem: true
        allowPrivilegeEscalation: false

  # ==========================================================================
  # AUTOSCALING
  # ==========================================================================
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    metrics:
      - type: Resource
        resource:
          name: cpu
          target:
            type: Utilization
            averageUtilization: 70

  # ==========================================================================
  # NETWORKING
  # ==========================================================================
  networking:
    domains:
      - name: app.janua.dev
        primary: true
        tls:
          enabled: true
          provider: cloudflare

    service:
      type: ClusterIP
      port: 3002  # External port per PORT_REGISTRY
      targetPort: 3000

    ingress:
      enabled: true
      annotations:
        nginx.ingress.kubernetes.io/configuration-snippet: |
          add_header X-Frame-Options "DENY" always;
          add_header X-Content-Type-Options "nosniff" always;
          add_header X-XSS-Protection "1; mode=block" always;

  # ==========================================================================
  # ENVIRONMENT CONFIGURATION
  # ==========================================================================
  env:
    - name: NODE_ENV
      value: production

    - name: PORT
      value: "3000"

    # Internal API URL (server-side, within cluster)
    - name: INTERNAL_API_URL
      value: "http://janua-api.enclii-platform.svc.cluster.local:8000"

    # Public API URL (client-side)
    - name: NEXT_PUBLIC_API_URL
      value: "https://api.janua.dev"

    # Public app URL
    - name: NEXT_PUBLIC_APP_URL
      value: "https://app.janua.dev"

    # Session secret
    - name: SESSION_SECRET
      valueFrom:
        secretKeyRef:
          name: janua-dashboard-secrets
          key: session-secret

  # ==========================================================================
  # DEPLOYMENT PIPELINE
  # ==========================================================================
  pipeline:
    autoDeploy: true

    stages:
      - name: build
        timeout: 600

      - name: deploy-canary
        replicas: 1
        duration: 180
        analysis:
          metrics:
            - name: error_rate
              threshold: 5
              operator: lessThan

      - name: deploy-production
        strategy: rolling
        rollbackOnFailure: true

  # ==========================================================================
  # MONITORING
  # ==========================================================================
  monitoring:
    prometheus:
      enabled: true
      path: /api/metrics
      port: 3000
