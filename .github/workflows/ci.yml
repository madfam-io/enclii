name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      force_build:
        description: 'Force rebuild all Docker images (bypass Conservation Law)'
        required: false
        default: 'false'
        type: boolean

env:
  GO_VERSION: '1.24'
  NODE_VERSION: '20'
  # Runner selection: Use self-hosted if ARC bootstrap is complete, otherwise GitHub-hosted
  # Set ARC_BOOTSTRAP_COMPLETE=true in repository variables after ARC is installed
  # Note: ARC runner scale set is named 'enclii-runners-blue' (blue/green deployment pattern)
  RUNNER_LABEL: ${{ vars.ARC_BOOTSTRAP_COMPLETE == 'true' && 'enclii-runners-blue' || 'ubuntu-latest' }}

jobs:
  lint:
    name: Lint & Format
    runs-on: ${{ vars.ARC_BOOTSTRAP_COMPLETE == 'true' && 'enclii-runners-blue' || 'ubuntu-latest' }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install golangci-lint
        run: |
          go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@latest

      - name: Run golangci-lint on switchyard-api
        working-directory: apps/switchyard-api
        run: golangci-lint run --timeout=5m ./...

      - name: Run golangci-lint on roundhouse
        working-directory: apps/roundhouse
        run: golangci-lint run --timeout=5m ./...

      - name: Run golangci-lint on waybill
        working-directory: apps/waybill
        run: golangci-lint run --timeout=5m ./...

      - name: Run golangci-lint on CLI
        working-directory: packages/cli
        run: golangci-lint run --timeout=5m ./...

      - name: Check Go formatting
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Go files are not formatted:"
            gofmt -l .
            exit 1
          fi

  # =============================================================================
  # OPERATION RATCHET: Stability Enforcement Jobs
  # =============================================================================

  manifest-audit:
    name: Manifest Audit (Ratchet)
    runs-on: ${{ vars.ARC_BOOTSTRAP_COMPLETE == 'true' && 'enclii-runners-blue' || 'ubuntu-latest' }}
    # Run in parallel with lint for speed
    steps:
      - uses: actions/checkout@v6

      - name: Check critical config keys
        run: |
          echo "üîí Operation Ratchet - Manifest Audit"
          echo ""
          FAILED=0

          # --- environment-patch.yaml ---
          echo "Checking: infra/k8s/production/environment-patch.yaml"
          ENV_PATCH="infra/k8s/production/environment-patch.yaml"
          for key in "ENCLII_OIDC_ISSUER" "ENCLII_OIDC_CLIENT_ID" "ENCLII_OIDC_CLIENT_SECRET" "ENCLII_EXTERNAL_JWKS_URL"; do
            if grep -q "$key" "$ENV_PATCH" 2>/dev/null; then
              echo "  ‚úÖ $key"
            else
              echo "  ‚ùå MISSING: $key"
              FAILED=1
            fi
          done

          # --- cloudflared-unified.yaml ---
          echo ""
          echo "Checking: infra/k8s/production/cloudflared-unified.yaml"
          CLOUDFLARED="infra/k8s/production/cloudflared-unified.yaml"
          for hostname in "api.enclii.dev" "app.enclii.dev" "admin.enclii.dev" "auth.madfam.io"; do
            if grep -q "hostname: $hostname" "$CLOUDFLARED" 2>/dev/null; then
              echo "  ‚úÖ hostname: $hostname"
            else
              echo "  ‚ùå MISSING ROUTE: $hostname"
              FAILED=1
            fi
          done

          # --- roundhouse.yaml ---
          echo ""
          echo "Checking: infra/k8s/base/roundhouse.yaml"
          ROUNDHOUSE="infra/k8s/base/roundhouse.yaml"
          if grep -q "imagePullSecrets:" "$ROUNDHOUSE" 2>/dev/null; then
            echo "  ‚úÖ imagePullSecrets"
          else
            echo "  ‚ùå MISSING: imagePullSecrets"
            FAILED=1
          fi

          # --- dispatch deployment ---
          echo ""
          echo "Checking: apps/dispatch/k8s/deployment.yaml"
          DISPATCH="apps/dispatch/k8s/deployment.yaml"
          for key in "imagePullSecrets:" "ALLOWED_ADMIN_DOMAINS" "ALLOWED_ADMIN_ROLES" "NEXT_PUBLIC_JANUA_URL"; do
            if grep -q "$key" "$DISPATCH" 2>/dev/null; then
              echo "  ‚úÖ $key"
            else
              echo "  ‚ùå MISSING: $key"
              FAILED=1
            fi
          done

          # --- Port consistency check (Operation Fortification) ---
          echo ""
          echo "üîí Port Consistency Check (Fortification)"
          echo "Checking: infra/k8s/base/switchyard-api.yaml"
          API_MANIFEST="infra/k8s/base/switchyard-api.yaml"
          if grep -q "containerPort: 8080" "$API_MANIFEST"; then
            echo "  ‚ùå FORBIDDEN: containerPort: 8080 (must be 4200)"
            FAILED=1
          else
            echo "  ‚úÖ containerPort: 4200"
          fi
          if grep -q "targetPort: 8080" "$API_MANIFEST"; then
            echo "  ‚ùå FORBIDDEN: targetPort: 8080 (must be 4200)"
            FAILED=1
          else
            echo "  ‚úÖ targetPort: 4200"
          fi
          if grep -E "port: 8080" "$API_MANIFEST"; then
            echo "  ‚ùå FORBIDDEN: port 8080 found in manifest"
            FAILED=1
          else
            echo "  ‚úÖ All ports use 4200"
          fi

          echo ""
          if [ $FAILED -eq 1 ]; then
            echo "‚ùå Manifest audit FAILED - critical config keys missing!"
            echo "   See SYSTEM_CONTEXT.md 'Operation Ratchet - Rules of Engagement'"
            exit 1
          fi
          echo "‚úÖ Manifest audit passed (including port consistency)!"

  golden-config:
    name: Golden Config Check (Ratchet)
    runs-on: ${{ vars.ARC_BOOTSTRAP_COMPLETE == 'true' && 'enclii-runners-blue' || 'ubuntu-latest' }}
    # Run in parallel with lint for speed
    steps:
      - uses: actions/checkout@v6

      - name: Check golden config drift
        run: |
          echo "üîí Operation Ratchet - Golden Config Check"
          echo ""
          if [ -x "./scripts/check-golden.sh" ]; then
            ./scripts/check-golden.sh
          else
            echo "‚ö†Ô∏è Golden config check not available (scripts/check-golden.sh missing)"
            echo "   Run './scripts/update-golden.sh' to initialize golden configs"
            exit 0  # Graceful skip if not initialized
          fi

  unit-tests:
    name: Unit Tests
    # Always use GitHub-hosted runners for unit tests because service containers
    # (postgres, redis) require Docker, which isn't available on ARC self-hosted runners
    runs-on: ubuntu-latest
    needs: lint

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: enclii
          POSTGRES_PASSWORD: enclii_test
          POSTGRES_DB: enclii_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run switchyard-api tests
        working-directory: apps/switchyard-api
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
        env:
          DATABASE_URL: postgres://enclii:enclii_test@localhost:5432/enclii_test?sslmode=disable
          REDIS_URL: redis://localhost:6379/0
          JWT_SECRET: test-secret-key
          ENV: test

      - name: Run roundhouse tests
        working-directory: apps/roundhouse
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
        env:
          REDIS_URL: redis://localhost:6379/0
          ENV: test

      - name: Run waybill tests
        working-directory: apps/waybill
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
        env:
          DATABASE_URL: postgres://enclii:enclii_test@localhost:5432/enclii_test?sslmode=disable
          ENV: test

      - name: Run CLI tests
        working-directory: packages/cli
        run: go test -v -race ./...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./apps/switchyard-api/coverage.out,./apps/roundhouse/coverage.out,./apps/waybill/coverage.out
          flags: unit
          name: enclii-coverage

  build:
    name: Build
    runs-on: ${{ vars.ARC_BOOTSTRAP_COMPLETE == 'true' && 'enclii-runners-blue' || 'ubuntu-latest' }}
    needs: unit-tests

    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build switchyard-api
        working-directory: apps/switchyard-api
        run: go build -o ../../bin/switchyard-api ./cmd/api

      - name: Build roundhouse-api
        working-directory: apps/roundhouse
        run: go build -o ../../bin/roundhouse-api ./cmd/api

      - name: Build roundhouse-worker
        working-directory: apps/roundhouse
        run: go build -o ../../bin/roundhouse-worker ./cmd/worker

      - name: Build waybill-api
        working-directory: apps/waybill
        run: go build -o ../../bin/waybill-api ./cmd/api

      - name: Build waybill-aggregator
        working-directory: apps/waybill
        run: go build -o ../../bin/waybill-aggregator ./cmd/aggregator

      - name: Build CLI
        working-directory: packages/cli
        run: go build -o ../../bin/enclii ./cmd/enclii

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: enclii-binaries
          path: bin/
          retention-days: 7

  ui-tests:
    name: UI Tests
    runs-on: ${{ vars.ARC_BOOTSTRAP_COMPLETE == 'true' && 'enclii-runners-blue' || 'ubuntu-latest' }}
    # Serialize with lint to avoid resource contention on self-hosted runners
    needs: lint

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/switchyard-ui/package-lock.json

      - name: Install dependencies
        working-directory: apps/switchyard-ui
        run: npm ci

      - name: Run linting
        working-directory: apps/switchyard-ui
        run: npm run lint

      - name: Run tests
        working-directory: apps/switchyard-ui
        run: npm test -- --coverage --passWithNoTests

      - name: Build UI
        working-directory: apps/switchyard-ui
        run: npm run build

  # =============================================================================
  # OPERATION FORTIFICATION: Ecosystem E2E Tests (Blocking)
  # =============================================================================
  ecosystem-e2e:
    name: Ecosystem E2E (Blocking)
    runs-on: ubuntu-latest
    needs: [build, ui-tests]
    # Only run on main branch pushes (production validation)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: tests/e2e-ecosystem/package-lock.json

      - name: Install dependencies
        working-directory: tests/e2e-ecosystem
        run: npm ci || npm install

      - name: Install Playwright browsers
        working-directory: tests/e2e-ecosystem
        run: npx playwright install chromium --with-deps

      - name: Run E2E tests
        working-directory: tests/e2e-ecosystem
        run: npx playwright test
        env:
          CI: true
          API_BASE_URL: https://api.enclii.dev
          APP_BASE_URL: https://app.enclii.dev
          JANUA_URL: https://auth.madfam.io

      - name: Upload test report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: e2e-ecosystem-report
          path: tests/e2e-ecosystem/playwright-report/
          retention-days: 7

  security-scan:
    name: Security Scan
    runs-on: ${{ vars.ARC_BOOTSTRAP_COMPLETE == 'true' && 'enclii-runners-blue' || 'ubuntu-latest' }}
    # Serialize with ui-tests to avoid resource contention on self-hosted runners
    needs: ui-tests

    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: Run gosec on switchyard-api
        working-directory: apps/switchyard-api
        run: gosec -exclude-generated ./...
        continue-on-error: true

      - name: Run gosec on roundhouse
        working-directory: apps/roundhouse
        run: gosec -exclude-generated ./...
        continue-on-error: true

      - name: Run gosec on waybill
        working-directory: apps/waybill
        run: gosec -exclude-generated ./...
        continue-on-error: true

      - name: Check for vulnerabilities
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          cd apps/switchyard-api && govulncheck ./... || true
          cd ../roundhouse && govulncheck ./... || true
          cd ../waybill && govulncheck ./... || true

  # =============================================================================
  # CONSERVATION LAW (ADR-001 Law 6): Differential Builds
  # Only rebuild services that have actually changed
  # =============================================================================
  detect-changes:
    name: Detect Changes (Conservation Law)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      switchyard-api: ${{ steps.filter.outputs.switchyard-api }}
      switchyard-ui: ${{ steps.filter.outputs.switchyard-ui }}
      roundhouse: ${{ steps.filter.outputs.roundhouse }}
      waybill: ${{ steps.filter.outputs.waybill }}
      landing: ${{ steps.filter.outputs.landing }}
      dispatch: ${{ steps.filter.outputs.dispatch }}
      status: ${{ steps.filter.outputs.status }}
    steps:
      - uses: actions/checkout@v6

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            switchyard-api:
              - 'apps/switchyard-api/**'
              - 'packages/core/**'
            switchyard-ui:
              - 'apps/switchyard-ui/**'
              - 'packages/ui/**'
            roundhouse:
              - 'apps/roundhouse/**'
              - 'packages/core/**'
            waybill:
              - 'apps/waybill/**'
              - 'packages/core/**'
            landing:
              - 'apps/landing/**'
            dispatch:
              - 'apps/dispatch/**'
              - 'packages/ui/**'
            status:
              - 'apps/status/**'

      - name: Log detected changes
        run: |
          echo "üîç Conservation Law - Change Detection Results:"
          echo "  switchyard-api: ${{ steps.filter.outputs.switchyard-api }}"
          echo "  switchyard-ui:  ${{ steps.filter.outputs.switchyard-ui }}"
          echo "  roundhouse:     ${{ steps.filter.outputs.roundhouse }}"
          echo "  waybill:        ${{ steps.filter.outputs.waybill }}"
          echo "  landing:        ${{ steps.filter.outputs.landing }}"
          echo "  dispatch:       ${{ steps.filter.outputs.dispatch }}"
          echo "  status:         ${{ steps.filter.outputs.status }}"

  docker-build:
    name: Docker Build
    # Docker builds benefit most from self-hosted runners (DinD, build cache)
    runs-on: ${{ vars.ARC_BOOTSTRAP_COMPLETE == 'true' && 'enclii-runners-blue' || 'ubuntu-latest' }}
    # HARD GATE 1: E2E must pass before Docker build (Operation Fortification)
    needs: [build, ui-tests, detect-changes, ecosystem-e2e]
    # Use always() to run even when detect-changes/ecosystem-e2e is skipped
    # E2E must pass on main branch pushes (Operation Fortification HARD GATE)
    if: |
      always() &&
      (needs.build.result == 'success') &&
      (needs.ui-tests.result == 'success') &&
      (needs.ecosystem-e2e.result == 'success' || needs.ecosystem-e2e.result == 'skipped') &&
      ((github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch')
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v6

      # Wait for Docker daemon (DinD sidecar) to be ready on self-hosted runners
      - name: Wait for Docker daemon
        if: vars.ARC_BOOTSTRAP_COMPLETE == 'true'
        run: |
          echo "Waiting for Docker daemon to be ready..."
          for i in $(seq 1 30); do
            if docker info >/dev/null 2>&1; then
              echo "Docker daemon is ready!"
              docker version
              exit 0
            fi
            echo "Attempt $i/30: Docker not ready, waiting 2 seconds..."
            sleep 2
          done
          echo "ERROR: Docker daemon did not become ready in time"
          exit 1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Conservation Law: Only build if changes detected
      - name: Build and push switchyard-api
        if: needs.detect-changes.outputs.switchyard-api == 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/switchyard-api/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/switchyard-api:${{ github.sha }}
            ghcr.io/${{ github.repository }}/switchyard-api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Skip switchyard-api (no changes)
        if: needs.detect-changes.outputs.switchyard-api != 'true' && github.event_name != 'workflow_dispatch'
        run: echo "‚è≠Ô∏è Skipping switchyard-api build (Conservation Law - no changes detected)"

      # Conservation Law: Only build if changes detected
      - name: Build and push switchyard-ui
        if: needs.detect-changes.outputs.switchyard-ui == 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/switchyard-ui/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/switchyard-ui:${{ github.sha }}
            ghcr.io/${{ github.repository }}/switchyard-ui:latest
          build-args: |
            NEXT_PUBLIC_API_URL=https://api.enclii.dev
            NEXT_PUBLIC_AUTH_MODE=oidc
            NEXT_PUBLIC_JANUA_URL=https://auth.madfam.io
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Skip switchyard-ui (no changes)
        if: needs.detect-changes.outputs.switchyard-ui != 'true' && github.event_name != 'workflow_dispatch'
        run: echo "‚è≠Ô∏è Skipping switchyard-ui build (Conservation Law - no changes detected)"

      # Conservation Law: Only build if changes detected
      - name: Build and push roundhouse
        if: needs.detect-changes.outputs.roundhouse == 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/roundhouse/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/roundhouse:${{ github.sha }}
            ghcr.io/${{ github.repository }}/roundhouse:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Skip roundhouse (no changes)
        if: needs.detect-changes.outputs.roundhouse != 'true' && github.event_name != 'workflow_dispatch'
        run: echo "‚è≠Ô∏è Skipping roundhouse build (Conservation Law - no changes detected)"

      # Conservation Law: Only build if changes detected
      - name: Build and push waybill
        if: needs.detect-changes.outputs.waybill == 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/waybill/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/waybill:${{ github.sha }}
            ghcr.io/${{ github.repository }}/waybill:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Skip waybill (no changes)
        if: needs.detect-changes.outputs.waybill != 'true' && github.event_name != 'workflow_dispatch'
        run: echo "‚è≠Ô∏è Skipping waybill build (Conservation Law - no changes detected)"

      # Conservation Law: Only build if changes detected
      - name: Build and push landing-page
        if: needs.detect-changes.outputs.landing == 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/landing/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/landing-page:${{ github.sha }}
            ghcr.io/${{ github.repository }}/landing-page:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Skip landing-page (no changes)
        if: needs.detect-changes.outputs.landing != 'true' && github.event_name != 'workflow_dispatch'
        run: echo "‚è≠Ô∏è Skipping landing-page build (Conservation Law - no changes detected)"

      # Conservation Law: Only build if changes detected
      - name: Build and push dispatch
        if: needs.detect-changes.outputs.dispatch == 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/dispatch/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/dispatch:${{ github.sha }}
            ghcr.io/${{ github.repository }}/dispatch:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Skip dispatch (no changes)
        if: needs.detect-changes.outputs.dispatch != 'true' && github.event_name != 'workflow_dispatch'
        run: echo "‚è≠Ô∏è Skipping dispatch build (Conservation Law - no changes detected)"

      # Conservation Law: Only build if changes detected
      - name: Build and push status
        if: needs.detect-changes.outputs.status == 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/status/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/enclii-status:${{ github.sha }}
            ghcr.io/${{ github.repository }}/enclii-status:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Skip status (no changes)
        if: needs.detect-changes.outputs.status != 'true' && github.event_name != 'workflow_dispatch'
        run: echo "‚è≠Ô∏è Skipping status build (Conservation Law - no changes detected)"

  # =============================================================================
  # DEPLOYMENT VERIFICATION: Guardrail for ArgoCD Image Updater
  # Verifies that new images trigger automatic deployment via digest strategy
  # =============================================================================
  verify-deployment:
    name: Verify Deployment Trigger
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: |
      always() &&
      needs.docker-build.result == 'success' &&
      github.ref == 'refs/heads/main'

    steps:
      - name: Setup kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_PRODUCTION }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Wait for ArgoCD Image Updater
        run: |
          echo "‚è≥ Waiting 90s for Image Updater to detect new images..."
          sleep 90

      - name: Check ArgoCD Application Status
        run: |
          echo "üîç Checking ArgoCD core-services application..."

          # Get the Application CR status
          APP_STATUS=$(kubectl get application core-services -n argocd -o jsonpath='{.status.sync.status}' 2>/dev/null || echo "NotFound")
          HEALTH_STATUS=$(kubectl get application core-services -n argocd -o jsonpath='{.status.health.status}' 2>/dev/null || echo "Unknown")

          echo "Sync Status: $APP_STATUS"
          echo "Health Status: $HEALTH_STATUS"

          # Check if Image Updater has detected the change
          echo ""
          echo "üì¶ Recent Image Updater activity:"
          kubectl logs -n argocd -l app.kubernetes.io/name=argocd-image-updater --tail=20 2>/dev/null || echo "Image Updater logs not available"

          # Verify deployment pods
          echo ""
          echo "üöÄ Current deployment status:"
          kubectl get deployments -n enclii -o wide

          echo ""
          echo "‚úÖ Deployment verification complete"
          echo "   Sync: $APP_STATUS | Health: $HEALTH_STATUS"

      - name: Check for Image Updates
        run: |
          echo "üìã Checking if images were updated..."

          # Show current images in deployments
          for deploy in switchyard-api switchyard-ui roundhouse; do
            IMAGE=$(kubectl get deployment $deploy -n enclii -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null || echo "not found")
            echo "  $deploy: $IMAGE"
          done

  test-summary:
    name: Test Summary
    runs-on: ${{ vars.ARC_BOOTSTRAP_COMPLETE == 'true' && 'enclii-runners-blue' || 'ubuntu-latest' }}
    needs: [lint, unit-tests, ui-tests, security-scan, manifest-audit, golden-config, ecosystem-e2e]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "‚ùå Lint failed"
            exit 1
          fi
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "‚ùå Unit tests failed"
            exit 1
          fi
          if [ "${{ needs.ui-tests.result }}" != "success" ]; then
            echo "‚ùå UI tests failed"
            exit 1
          fi
          if [ "${{ needs.manifest-audit.result }}" != "success" ]; then
            echo "‚ùå Manifest audit failed (Operation Ratchet)"
            exit 1
          fi
          if [ "${{ needs.golden-config.result }}" != "success" ]; then
            echo "‚ùå Golden config check failed (Operation Ratchet)"
            exit 1
          fi
          # Ecosystem E2E is only required on main branch pushes
          if [ "${{ needs.ecosystem-e2e.result }}" == "failure" ]; then
            echo "‚ùå Ecosystem E2E failed (Operation Fortification)"
            exit 1
          fi
          echo "‚úÖ All CI checks passed (including Operation Ratchet + Fortification)!"
