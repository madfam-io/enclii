name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  GO_VERSION: '1.24'
  NODE_VERSION: '20'
  # Runner selection: Use self-hosted if ARC bootstrap is complete, otherwise GitHub-hosted
  # Set ARC_BOOTSTRAP_COMPLETE=true in repository variables after ARC is installed
  # Note: ARC runner scale set is named 'enclii-runners-blue' (blue/green deployment pattern)
  RUNNER_LABEL: ${{ vars.ARC_BOOTSTRAP_COMPLETE == 'true' && 'enclii-runners-blue' || 'ubuntu-latest' }}

jobs:
  lint:
    name: Lint & Format
    runs-on: ${{ vars.ARC_BOOTSTRAP_COMPLETE == 'true' && 'enclii-runners-blue' || 'ubuntu-latest' }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install golangci-lint
        run: |
          go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@latest

      - name: Run golangci-lint on switchyard-api
        working-directory: apps/switchyard-api
        run: golangci-lint run --timeout=5m ./...

      - name: Run golangci-lint on roundhouse
        working-directory: apps/roundhouse
        run: golangci-lint run --timeout=5m ./...

      - name: Run golangci-lint on waybill
        working-directory: apps/waybill
        run: golangci-lint run --timeout=5m ./...

      - name: Run golangci-lint on CLI
        working-directory: packages/cli
        run: golangci-lint run --timeout=5m ./...

      - name: Check Go formatting
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Go files are not formatted:"
            gofmt -l .
            exit 1
          fi

  unit-tests:
    name: Unit Tests
    # Always use GitHub-hosted runners for unit tests because service containers
    # (postgres, redis) require Docker, which isn't available on ARC self-hosted runners
    runs-on: ubuntu-latest
    needs: lint

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: enclii
          POSTGRES_PASSWORD: enclii_test
          POSTGRES_DB: enclii_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run switchyard-api tests
        working-directory: apps/switchyard-api
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
        env:
          DATABASE_URL: postgres://enclii:enclii_test@localhost:5432/enclii_test?sslmode=disable
          REDIS_URL: redis://localhost:6379/0
          JWT_SECRET: test-secret-key
          ENV: test

      - name: Run roundhouse tests
        working-directory: apps/roundhouse
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
        env:
          REDIS_URL: redis://localhost:6379/0
          ENV: test

      - name: Run waybill tests
        working-directory: apps/waybill
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
        env:
          DATABASE_URL: postgres://enclii:enclii_test@localhost:5432/enclii_test?sslmode=disable
          ENV: test

      - name: Run CLI tests
        working-directory: packages/cli
        run: go test -v -race ./...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./apps/switchyard-api/coverage.out,./apps/roundhouse/coverage.out,./apps/waybill/coverage.out
          flags: unit
          name: enclii-coverage

  build:
    name: Build
    runs-on: ${{ vars.ARC_BOOTSTRAP_COMPLETE == 'true' && 'enclii-runners-blue' || 'ubuntu-latest' }}
    needs: unit-tests

    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build switchyard-api
        working-directory: apps/switchyard-api
        run: go build -o ../../bin/switchyard-api ./cmd/api

      - name: Build roundhouse-api
        working-directory: apps/roundhouse
        run: go build -o ../../bin/roundhouse-api ./cmd/api

      - name: Build roundhouse-worker
        working-directory: apps/roundhouse
        run: go build -o ../../bin/roundhouse-worker ./cmd/worker

      - name: Build waybill-api
        working-directory: apps/waybill
        run: go build -o ../../bin/waybill-api ./cmd/api

      - name: Build waybill-aggregator
        working-directory: apps/waybill
        run: go build -o ../../bin/waybill-aggregator ./cmd/aggregator

      - name: Build CLI
        working-directory: packages/cli
        run: go build -o ../../bin/enclii ./cmd/enclii

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: enclii-binaries
          path: bin/
          retention-days: 7

  ui-tests:
    name: UI Tests
    runs-on: ${{ vars.ARC_BOOTSTRAP_COMPLETE == 'true' && 'enclii-runners-blue' || 'ubuntu-latest' }}

    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/switchyard-ui/package-lock.json

      - name: Install dependencies
        working-directory: apps/switchyard-ui
        run: npm ci

      - name: Run linting
        working-directory: apps/switchyard-ui
        run: npm run lint

      - name: Run tests
        working-directory: apps/switchyard-ui
        run: npm test -- --coverage --passWithNoTests

      - name: Build UI
        working-directory: apps/switchyard-ui
        run: npm run build

  security-scan:
    name: Security Scan
    runs-on: ${{ vars.ARC_BOOTSTRAP_COMPLETE == 'true' && 'enclii-runners-blue' || 'ubuntu-latest' }}

    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: Run gosec on switchyard-api
        working-directory: apps/switchyard-api
        run: gosec -exclude-generated ./...
        continue-on-error: true

      - name: Run gosec on roundhouse
        working-directory: apps/roundhouse
        run: gosec -exclude-generated ./...
        continue-on-error: true

      - name: Run gosec on waybill
        working-directory: apps/waybill
        run: gosec -exclude-generated ./...
        continue-on-error: true

      - name: Check for vulnerabilities
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          cd apps/switchyard-api && govulncheck ./... || true
          cd ../roundhouse && govulncheck ./... || true
          cd ../waybill && govulncheck ./... || true

  # =============================================================================
  # CONSERVATION LAW (ADR-001 Law 6): Differential Builds
  # Only rebuild services that have actually changed
  # =============================================================================
  detect-changes:
    name: Detect Changes (Conservation Law)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      switchyard-api: ${{ steps.filter.outputs.switchyard-api }}
      switchyard-ui: ${{ steps.filter.outputs.switchyard-ui }}
      roundhouse: ${{ steps.filter.outputs.roundhouse }}
      waybill: ${{ steps.filter.outputs.waybill }}
      landing: ${{ steps.filter.outputs.landing }}
      dispatch: ${{ steps.filter.outputs.dispatch }}
    steps:
      - uses: actions/checkout@v6

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            switchyard-api:
              - 'apps/switchyard-api/**'
              - 'packages/core/**'
            switchyard-ui:
              - 'apps/switchyard-ui/**'
              - 'packages/ui/**'
            roundhouse:
              - 'apps/roundhouse/**'
              - 'packages/core/**'
            waybill:
              - 'apps/waybill/**'
              - 'packages/core/**'
            landing:
              - 'apps/landing/**'
            dispatch:
              - 'apps/dispatch/**'
              - 'packages/ui/**'

      - name: Log detected changes
        run: |
          echo "üîç Conservation Law - Change Detection Results:"
          echo "  switchyard-api: ${{ steps.filter.outputs.switchyard-api }}"
          echo "  switchyard-ui:  ${{ steps.filter.outputs.switchyard-ui }}"
          echo "  roundhouse:     ${{ steps.filter.outputs.roundhouse }}"
          echo "  waybill:        ${{ steps.filter.outputs.waybill }}"
          echo "  landing:        ${{ steps.filter.outputs.landing }}"
          echo "  dispatch:       ${{ steps.filter.outputs.dispatch }}"

  docker-build:
    name: Docker Build
    # Docker builds benefit most from self-hosted runners (DinD, build cache)
    runs-on: ${{ vars.ARC_BOOTSTRAP_COMPLETE == 'true' && 'enclii-runners-blue' || 'ubuntu-latest' }}
    needs: [build, ui-tests, detect-changes]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Conservation Law: Only build if changes detected
      - name: Build and push switchyard-api
        if: needs.detect-changes.outputs.switchyard-api == 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/switchyard-api/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository }}/switchyard-api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Skip switchyard-api (no changes)
        if: needs.detect-changes.outputs.switchyard-api != 'true' && github.event_name != 'workflow_dispatch'
        run: echo "‚è≠Ô∏è Skipping switchyard-api build (Conservation Law - no changes detected)"

      # Conservation Law: Only build if changes detected
      - name: Build and push switchyard-ui
        if: needs.detect-changes.outputs.switchyard-ui == 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: apps/switchyard-ui/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository }}/switchyard-ui:${{ github.sha }}
          build-args: |
            NEXT_PUBLIC_API_URL=https://api.enclii.dev
            NEXT_PUBLIC_AUTH_MODE=oidc
            NEXT_PUBLIC_JANUA_URL=https://auth.madfam.io
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Skip switchyard-ui (no changes)
        if: needs.detect-changes.outputs.switchyard-ui != 'true' && github.event_name != 'workflow_dispatch'
        run: echo "‚è≠Ô∏è Skipping switchyard-ui build (Conservation Law - no changes detected)"

      # Conservation Law: Only build if changes detected
      - name: Build and push roundhouse
        if: needs.detect-changes.outputs.roundhouse == 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v6
        with:
          context: apps/roundhouse
          push: true
          tags: ghcr.io/${{ github.repository }}/roundhouse:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Skip roundhouse (no changes)
        if: needs.detect-changes.outputs.roundhouse != 'true' && github.event_name != 'workflow_dispatch'
        run: echo "‚è≠Ô∏è Skipping roundhouse build (Conservation Law - no changes detected)"

      # Conservation Law: Only build if changes detected
      - name: Build and push waybill
        if: needs.detect-changes.outputs.waybill == 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v6
        with:
          context: apps/waybill
          push: true
          tags: ghcr.io/${{ github.repository }}/waybill:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Skip waybill (no changes)
        if: needs.detect-changes.outputs.waybill != 'true' && github.event_name != 'workflow_dispatch'
        run: echo "‚è≠Ô∏è Skipping waybill build (Conservation Law - no changes detected)"

      # Conservation Law: Only build if changes detected
      - name: Build and push landing-page
        if: needs.detect-changes.outputs.landing == 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v6
        with:
          context: apps/landing
          push: true
          tags: ghcr.io/${{ github.repository }}/landing-page:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Skip landing-page (no changes)
        if: needs.detect-changes.outputs.landing != 'true' && github.event_name != 'workflow_dispatch'
        run: echo "‚è≠Ô∏è Skipping landing-page build (Conservation Law - no changes detected)"

      # Conservation Law: Only build if changes detected
      - name: Build and push dispatch
        if: needs.detect-changes.outputs.dispatch == 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v6
        with:
          context: apps/dispatch
          push: true
          tags: ghcr.io/${{ github.repository }}/dispatch:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Skip dispatch (no changes)
        if: needs.detect-changes.outputs.dispatch != 'true' && github.event_name != 'workflow_dispatch'
        run: echo "‚è≠Ô∏è Skipping dispatch build (Conservation Law - no changes detected)"

  test-summary:
    name: Test Summary
    runs-on: ${{ vars.ARC_BOOTSTRAP_COMPLETE == 'true' && 'enclii-runners-blue' || 'ubuntu-latest' }}
    needs: [lint, unit-tests, ui-tests, security-scan]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "‚ùå Lint failed"
            exit 1
          fi
          if [ "${{ needs.unit-tests.result }}" != "success" ]; then
            echo "‚ùå Unit tests failed"
            exit 1
          fi
          if [ "${{ needs.ui-tests.result }}" != "success" ]; then
            echo "‚ùå UI tests failed"
            exit 1
          fi
          echo "‚úÖ All CI checks passed!"
