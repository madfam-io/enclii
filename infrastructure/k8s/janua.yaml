---
# Janua Identity Platform Deployment
# Namespace: janua-prod
# Image: ghcr.io/madfam-io/janua:latest
#
# This manifest deploys the Janua authentication and identity platform
# to the Enclii Sovereign Cloud.
#
# Prerequisites:
# 1. janua-data.yaml deployed (PostgreSQL + Redis)
# 2. cert-manager installed (for TLS certificates)
# 3. Traefik ingress controller running (default with k3s)
# 4. DNS record for janua.dev pointing to server IP
#
# Deployment:
#   kubectl apply -f janua-data.yaml  # Deploy data layer first
#   kubectl apply -f janua.yaml       # Deploy application layer
#
# Verification:
#   kubectl get pods -n janua-prod
#   kubectl get ingress -n janua-prod
#   curl https://janua.dev/health

apiVersion: v1
kind: Namespace
metadata:
  name: janua-prod
  labels:
    name: janua-prod
    app.kubernetes.io/name: janua
    app.kubernetes.io/component: identity-platform

---
apiVersion: v1
kind: Secret
metadata:
  name: janua-secrets
  namespace: janua-prod
type: Opaque
stringData:
  # IMPORTANT: Replace these placeholder values with actual secrets
  # Use kubectl create secret or external secret management (Vault, Lockbox)
  #
  # PostgreSQL connection string
  JANUA_DATABASE_URL: "postgresql://janua:CHANGE_ME@postgres.janua-prod.svc.cluster.local:5432/janua?sslmode=disable"

  # Redis connection string (for sessions and rate limiting)
  JANUA_REDIS_URL: "redis://redis.janua-prod.svc.cluster.local:6379/0"

  # JWT signing secret (generate with: openssl rand -base64 64)
  JANUA_SECRET: "CHANGE_ME_TO_RANDOM_64_BYTE_STRING"

  # Session secret (generate with: openssl rand -base64 32)
  JANUA_SESSION_SECRET: "CHANGE_ME_TO_RANDOM_32_BYTE_STRING"

  # SMTP configuration (for password resets, email verification)
  SMTP_HOST: "smtp.sendgrid.net"
  SMTP_PORT: "587"
  SMTP_USER: "apikey"
  SMTP_PASSWORD: "CHANGE_ME_TO_SENDGRID_API_KEY"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: janua-api
  namespace: janua-prod
  labels:
    app: janua-api
    app.kubernetes.io/name: janua
    app.kubernetes.io/component: api
    app.kubernetes.io/version: "latest"
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: janua-api
  template:
    metadata:
      labels:
        app: janua-api
        app.kubernetes.io/name: janua
        app.kubernetes.io/component: api
    spec:
      containers:
        - name: janua-api
          image: ghcr.io/madfam-io/janua:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8000
              protocol: TCP
          env:
            # Environment configuration
            - name: NODE_ENV
              value: "production"
            - name: PORT
              value: "8000"
            - name: LOG_LEVEL
              value: "info"
            - name: LOG_FORMAT
              value: "json"

            # Application URLs
            - name: JANUA_ISSUER
              value: "https://janua.dev"
            - name: JANUA_BASE_URL
              value: "https://janua.dev"

            # CORS configuration
            - name: CORS_ORIGIN
              value: "https://janua.dev"
            - name: JANUA_CORS_ORIGINS
              value: "https://janua.dev,https://app.enclii.io,https://api.enclii.io"

            # Database configuration (from secret)
            - name: JANUA_DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: JANUA_DATABASE_URL
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: JANUA_DATABASE_URL

            # Redis configuration (from secret)
            - name: JANUA_REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: JANUA_REDIS_URL
            - name: REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: JANUA_REDIS_URL

            # JWT configuration (from secret)
            - name: JANUA_SECRET
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: JANUA_SECRET
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: JANUA_SECRET

            # Session configuration (from secret)
            - name: JANUA_SESSION_SECRET
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: JANUA_SESSION_SECRET
            - name: JANUA_SESSION_DURATION
              value: "86400" # 24 hours

            # JWT algorithm
            - name: JANUA_JWT_ALGORITHM
              value: "RS256"

            # Email configuration (from secret)
            - name: JANUA_SMTP_HOST
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: SMTP_HOST
            - name: JANUA_SMTP_PORT
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: SMTP_PORT
            - name: JANUA_SMTP_USER
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: SMTP_USER
            - name: JANUA_SMTP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: SMTP_PASSWORD
            - name: JANUA_FROM_EMAIL
              value: "noreply@janua.dev"
            - name: JANUA_FROM_NAME
              value: "Janua Authentication"

            # Rate limiting
            - name: JANUA_RATE_LIMIT_ENABLED
              value: "true"
            - name: JANUA_RATE_LIMIT_REQUESTS
              value: "100"
            - name: JANUA_RATE_LIMIT_WINDOW
              value: "60" # 100 requests per minute

          # Health check endpoints
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /health/ready
              port: http
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 2

          # Resource limits
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi

          # Security context
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 1000
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: false

      # Security context for pod
      securityContext:
        fsGroup: 1000

---
apiVersion: v1
kind: Service
metadata:
  name: janua-api
  namespace: janua-prod
  labels:
    app: janua-api
    app.kubernetes.io/name: janua
    app.kubernetes.io/component: api
spec:
  type: ClusterIP
  ports:
    - port: 8000
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app: janua-api

---
# Standard Kubernetes Ingress (compatible with Traefik)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: janua-ingress
  namespace: janua-prod
  labels:
    app: janua-api
    app.kubernetes.io/name: janua
  annotations:
    # Traefik annotations
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"

    # cert-manager annotations for automatic TLS
    cert-manager.io/cluster-issuer: "letsencrypt-prod"

    # Security headers
    traefik.ingress.kubernetes.io/router.middlewares: janua-prod-security-headers@kubernetescrd
spec:
  tls:
    - hosts:
        - janua.dev
      secretName: janua-tls
  rules:
    - host: janua.dev
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: janua-api
                port:
                  number: 8000

---
# Optional: Traefik Middleware for security headers
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: security-headers
  namespace: janua-prod
spec:
  headers:
    customResponseHeaders:
      X-Content-Type-Options: "nosniff"
      X-Frame-Options: "DENY"
      X-XSS-Protection: "1; mode=block"
      Strict-Transport-Security: "max-age=31536000; includeSubDomains"
    customRequestHeaders:
      X-Forwarded-Proto: "https"

---
# LetsEncrypt ClusterIssuer (create this once per cluster)
# This uses HTTP-01 challenge via Traefik
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    # ACME server URL for Let's Encrypt production
    server: https://acme-v02.api.letsencrypt.org/directory

    # Email address for ACME registration (CHANGE THIS!)
    email: admin@janua.dev

    # Secret to store ACME account private key
    privateKeySecretRef:
      name: letsencrypt-prod-key

    # HTTP-01 solver using Traefik ingress
    solvers:
      - http01:
          ingress:
            class: traefik
