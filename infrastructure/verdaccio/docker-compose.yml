# Verdaccio Docker Compose for npm.madfam.io
# Deploy with: docker-compose up -d

version: '3.8'

services:
  verdaccio:
    image: verdaccio/verdaccio:5
    container_name: npm-madfam-io
    restart: unless-stopped
    environment:
      - VERDACCIO_PORT=4873
      - VERDACCIO_PUBLIC_URL=https://npm.madfam.io
    ports:
      - "4873:4873"
    volumes:
      - ./config.yaml:/verdaccio/conf/config.yaml:ro
      - ./htpasswd:/verdaccio/conf/htpasswd
      - verdaccio-storage:/verdaccio/storage
      - verdaccio-plugins:/verdaccio/plugins
    networks:
      - madfam-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4873/-/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.npm.rule=Host(`npm.madfam.io`)"
      - "traefik.http.routers.npm.entrypoints=websecure"
      - "traefik.http.routers.npm.tls.certresolver=letsencrypt"
      - "traefik.http.services.npm.loadbalancer.server.port=4873"

volumes:
  verdaccio-storage:
    driver: local
  verdaccio-plugins:
    driver: local

networks:
  madfam-network:
    external: true
