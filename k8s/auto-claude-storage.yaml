# Auto-Claude Persistent Storage
# 100Gi shared volume for git cache and agent worktrees

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: auto-claude-repo-cache
  namespace: madfam-automation
  labels:
    app: auto-claude
    component: storage
    managed-by: enclii
spec:
  accessModes:
    - ReadWriteMany  # Multiple agent pods can mount simultaneously
  storageClassName: hetzner-ssd
  resources:
    requests:
      storage: 100Gi

---
# Namespace for Auto-Claude resources
apiVersion: v1
kind: Namespace
metadata:
  name: madfam-automation
  labels:
    name: madfam-automation
    managed-by: enclii

---
# ConfigMap for git cache initialization
apiVersion: v1
kind: ConfigMap
metadata:
  name: auto-claude-git-repos
  namespace: madfam-automation
data:
  repositories: |
    janua
    enclii
    sim4d
    avala
    forj
    forgesight
    cotiza-studio
    dhanam
    primavera3d
    solarpunk-foundry
    madfam-site
    aureo-labs
    electrochem-sim
    fortuna
    bloom-scroll
    blueprint-harvester
    coforma-studio
    geom-core
    renec-spa

---
# Job to initialize git cache with bare clones
apiVersion: batch/v1
kind: Job
metadata:
  name: auto-claude-git-cache-init
  namespace: madfam-automation
spec:
  template:
    metadata:
      labels:
        app: auto-claude
        component: git-cache-init
    spec:
      restartPolicy: OnFailure
      containers:
      - name: git-cache-init
        image: alpine/git:latest
        command:
        - /bin/sh
        - -c
        - |
          #!/bin/sh
          set -e

          echo "üöÄ Initializing git cache for Auto-Claude agents..."

          # Create directory structure
          mkdir -p /workspace/repos/.git-cache
          mkdir -p /workspace/repos/active
          mkdir -p /workspace/sessions
          mkdir -p /workspace/cache/artifacts

          cd /workspace/repos/.git-cache

          # Read repositories from ConfigMap
          REPOS=$(cat /etc/config/repositories)

          for repo in $REPOS; do
            echo "üì¶ Cloning $repo..."
            if [ ! -d "$repo.git" ]; then
              git clone --mirror \
                "https://x-access-token:${GITHUB_TOKEN}@github.com/madfam-org/$repo.git" \
                "$repo.git" || echo "‚ö†Ô∏è  Failed to clone $repo (may not exist)"
            else
              echo "‚úÖ $repo.git already exists, updating..."
              git -C "$repo.git" remote update || echo "‚ö†Ô∏è  Failed to update $repo"
            fi
          done

          echo "‚úÖ Git cache initialization complete!"
          ls -lh /workspace/repos/.git-cache

        env:
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: auto-claude-secrets
              key: github-token

        volumeMounts:
        - name: repo-cache
          mountPath: /workspace/repos
        - name: repo-list
          mountPath: /etc/config

      volumes:
      - name: repo-cache
        persistentVolumeClaim:
          claimName: auto-claude-repo-cache
      - name: repo-list
        configMap:
          name: auto-claude-git-repos

---
# Secret placeholder (create manually or via sealed-secrets)
# kubectl create secret generic auto-claude-secrets -n madfam-automation \
#   --from-literal=github-token=ghp_xxxx \
#   --from-literal=redis-password=xxxx \
#   --from-literal=anthropic-api-key=sk-ant-xxxx \
#   --from-literal=janua-client-secret=jns_xxxx
apiVersion: v1
kind: Secret
metadata:
  name: auto-claude-secrets
  namespace: madfam-automation
type: Opaque
stringData:
  github-token: "REPLACE_WITH_ACTUAL_TOKEN"
  redis-password: "REPLACE_WITH_ACTUAL_PASSWORD"
  anthropic-api-key: "REPLACE_WITH_ACTUAL_KEY"
  janua-client-secret: "jns_3SRnFv5IF32bM3fkHH5bFQ3su9LlLJB3zqlvKbwIVdnqJ5paKc4u7DfMhg10ZTsc"
