# Disk Cleanup CronJob
# Purpose: Prevent disk exhaustion from stale container images and build artifacts
# Context: Host at 87% disk usage - risk of pod evictions without cleanup
# Schedule: Daily at 3 AM UTC
# Note: Uses crictl for k3s/containerd (not Docker)
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: disk-cleanup
  namespace: enclii
  labels:
    app: disk-cleanup
    app.kubernetes.io/name: disk-cleanup
    app.kubernetes.io/component: maintenance
    app.kubernetes.io/part-of: enclii
spec:
  schedule: "0 3 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 86400
      template:
        metadata:
          labels:
            app: disk-cleanup
        spec:
          restartPolicy: OnFailure
          hostPID: true
          containers:
            - name: cleanup
              image: rancher/k3s:v1.28.4-k3s2
              command:
                - /bin/sh
                - -c
                - |
                  echo "=== Disk Cleanup Started: $(date) ==="
                  echo "Disk usage before cleanup:"
                  df -h / /var/lib/rancher 2>/dev/null || df -h /

                  # Configure crictl to use k3s containerd socket
                  export CONTAINER_RUNTIME_ENDPOINT=unix:///run/k3s/containerd/containerd.sock

                  # Remove unused (dangling) images
                  echo "Pruning unused images..."
                  crictl rmi --prune 2>/dev/null || echo "Image prune completed or no images to prune"

                  # List and remove stopped containers older than 24h
                  echo "Cleaning stopped containers..."
                  CUTOFF=$(date -d '24 hours ago' +%s 2>/dev/null || date -v-24H +%s)
                  crictl ps -a -q | while read cid; do
                    if [ -n "$cid" ]; then
                      STATE=$(crictl inspect "$cid" 2>/dev/null | grep -o '"state": "[^"]*"' | head -1 | cut -d'"' -f4)
                      if [ "$STATE" = "CONTAINER_EXITED" ]; then
                        crictl rm "$cid" 2>/dev/null || true
                      fi
                    fi
                  done

                  echo "Disk usage after cleanup:"
                  df -h / /var/lib/rancher 2>/dev/null || df -h /
                  echo "=== Disk Cleanup Completed: $(date) ==="
              resources:
                requests:
                  memory: "64Mi"
                  cpu: "50m"
                limits:
                  memory: "256Mi"
                  cpu: "200m"
              volumeMounts:
                - name: containerd-socket
                  mountPath: /run/k3s/containerd/containerd.sock
                  readOnly: false
              securityContext:
                privileged: true
          volumes:
            - name: containerd-socket
              hostPath:
                path: /run/k3s/containerd/containerd.sock
                type: Socket
          nodeSelector:
            kubernetes.io/os: linux
          tolerations:
            - operator: Exists
