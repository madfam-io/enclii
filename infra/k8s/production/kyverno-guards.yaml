---
# OPERATION SENTINEL - Kyverno Enforcement Policies
# The "Bouncer" - Blocks bad deployments at the gate
# Applied: 2026-01-17

apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: block-host-ports
  annotations:
    policies.kyverno.io/title: Block Host Ports
    policies.kyverno.io/category: Security
    policies.kyverno.io/severity: high
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Prevents pods from using hostPort, which can expose services to the
      public network. All database and internal services must use ClusterIP
      or localhost binding only.
spec:
  validationFailureAction: Enforce
  background: true
  rules:
    - name: deny-host-ports
      match:
        any:
          - resources:
              kinds:
                - Pod
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - kyverno
                - sentinel
                - janua
                - data
                - enclii
      validate:
        message: >-
          hostPort is forbidden. Use ClusterIP services for internal communication.
          Law 1: All databases MUST bind to 127.0.0.1 or ClusterIP only.
        pattern:
          spec:
            containers:
              - ports:
                  - hostPort: "!*"
            =(initContainers):
              - ports:
                  - hostPort: "!*"
            =(ephemeralContainers):
              - ports:
                  - hostPort: "!*"

---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-health-probes
  annotations:
    policies.kyverno.io/title: Require Health Probes
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Deployment
    policies.kyverno.io/description: >-
      Requires all Deployments to have readinessProbe and livenessProbe
      configured on all containers. Prevents zombie pods and ensures
      proper orchestration.
spec:
  validationFailureAction: Enforce
  background: true
  rules:
    - name: require-readiness-probe
      match:
        any:
          - resources:
              kinds:
                - Deployment
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - kyverno
                - argocd
                - longhorn-system
                - cloudflare-tunnel
                - janua
                - data
                - enclii
      validate:
        message: >-
          Deployment containers must have a readinessProbe defined.
          Zombie pods are forbidden - all services must declare health checks.
        pattern:
          spec:
            template:
              spec:
                containers:
                  - readinessProbe:
                      httpGet: "?*"
    - name: require-liveness-probe
      match:
        any:
          - resources:
              kinds:
                - Deployment
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - kyverno
                - argocd
                - longhorn-system
                - cloudflare-tunnel
                - janua
                - data
                - enclii
      validate:
        message: >-
          Deployment containers must have a livenessProbe defined.
          Zombie pods are forbidden - all services must declare health checks.
        pattern:
          spec:
            template:
              spec:
                containers:
                  - livenessProbe:
                      httpGet: "?*"

---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: block-latest-ifnotpresent
  annotations:
    policies.kyverno.io/title: Block Latest Tag with IfNotPresent
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Prevents the dangerous combination of using :latest tag with
      imagePullPolicy: IfNotPresent, which can cause stale image issues.
      Either use a specific tag or Always pull latest.
spec:
  validationFailureAction: Enforce
  background: true
  rules:
    - name: deny-latest-ifnotpresent
      match:
        any:
          - resources:
              kinds:
                - Pod
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
      validate:
        message: >-
          Using imagePullPolicy: IfNotPresent with :latest tag is forbidden.
          The "Latest Trap" causes unpredictable deployments. Use either:
          1. A specific tag (e.g., :v1.2.3), or
          2. imagePullPolicy: Always with :latest
        foreach:
          - list: "request.object.spec.containers"
            deny:
              conditions:
                all:
                  - key: "{{ regex_match(':latest$|^[^:]+$', element.image) }}"
                    operator: Equals
                    value: true
                  - key: "{{ element.imagePullPolicy || 'IfNotPresent' }}"
                    operator: Equals
                    value: IfNotPresent
