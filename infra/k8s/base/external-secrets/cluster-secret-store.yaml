---
# External Secrets Operator - ClusterSecretStore
# Provides centralized secret management across all namespaces
#
# Supported Providers (configure one):
# - Doppler (recommended for simplicity)
# - HashiCorp Vault (for enterprise)
# - AWS Secrets Manager
# - GCP Secret Manager
# - Azure Key Vault
#
# Setup:
# 1. Create a service token in your secrets provider
# 2. Create the auth secret below with your token
# 3. Apply this ClusterSecretStore
# 4. Create ExternalSecrets in your namespaces

apiVersion: v1
kind: Namespace
metadata:
  name: external-secrets
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secrets-management

---
# Auth secret for Doppler
# Create with: kubectl create secret generic doppler-token-auth -n external-secrets --from-literal=dopplerToken=dp.st.xxx
apiVersion: v1
kind: Secret
metadata:
  name: doppler-token-auth
  namespace: external-secrets
  labels:
    app.kubernetes.io/name: external-secrets
type: Opaque
stringData:
  # Replace with your Doppler service token
  # Get from: Doppler Dashboard → Project → Access → Service Tokens
  dopplerToken: "${DOPPLER_SERVICE_TOKEN}"

---
# ClusterSecretStore for Doppler
# Enables any namespace to sync secrets from Doppler
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: doppler-store
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secrets-management
spec:
  provider:
    doppler:
      auth:
        secretRef:
          dopplerToken:
            name: doppler-token-auth
            namespace: external-secrets
            key: dopplerToken

---
# Alternative: ClusterSecretStore for HashiCorp Vault
# Uncomment and configure if using Vault instead of Doppler
#
# apiVersion: external-secrets.io/v1beta1
# kind: ClusterSecretStore
# metadata:
#   name: vault-store
# spec:
#   provider:
#     vault:
#       server: "https://vault.example.com"
#       path: "secret"
#       version: "v2"
#       auth:
#         kubernetes:
#           mountPath: "kubernetes"
#           role: "external-secrets"
#           serviceAccountRef:
#             name: external-secrets
#             namespace: external-secrets

---
# Alternative: ClusterSecretStore for Kubernetes secrets (for migration)
# Copies secrets from a central namespace to others
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: kubernetes-store
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secrets-management
spec:
  provider:
    kubernetes:
      # Reference secrets from the 'enclii' namespace
      remoteNamespace: enclii
      server:
        caProvider:
          type: ConfigMap
          name: kube-root-ca.crt
          namespace: kube-system
          key: ca.crt
      auth:
        serviceAccount:
          name: external-secrets
          namespace: external-secrets
