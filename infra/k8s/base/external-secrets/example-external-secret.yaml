---
# Example ExternalSecret - Syncs secrets from Doppler to Kubernetes
#
# This creates a Kubernetes Secret that is automatically synced
# from your Doppler project. Changes in Doppler are reflected
# in Kubernetes within the refresh interval.
#
# Usage:
# 1. Ensure ClusterSecretStore is configured
# 2. Create secrets in Doppler project
# 3. Apply this ExternalSecret
# 4. Reference the created secret in your deployments

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: enclii-secrets-synced
  namespace: enclii
  labels:
    app.kubernetes.io/name: enclii
    app.kubernetes.io/component: secrets
spec:
  # How often to sync from the external provider
  refreshInterval: 1h

  # Reference to the ClusterSecretStore
  secretStoreRef:
    name: doppler-store
    kind: ClusterSecretStore

  # Target secret that will be created/updated
  target:
    name: enclii-secrets-synced
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: enclii
          app.kubernetes.io/managed-by: external-secrets

  # Map Doppler secrets to Kubernetes secret keys
  data:
    # Database credentials
    - secretKey: database-url
      remoteRef:
        key: DATABASE_URL

    # Redis URL
    - secretKey: redis-url
      remoteRef:
        key: REDIS_URL

    # OIDC credentials
    - secretKey: oidc-client-id
      remoteRef:
        key: OIDC_CLIENT_ID

    - secretKey: oidc-client-secret
      remoteRef:
        key: OIDC_CLIENT_SECRET

    # API keys
    - secretKey: internal-api-key
      remoteRef:
        key: INTERNAL_API_KEY

    # GitHub webhook secret
    - secretKey: github-webhook-secret
      remoteRef:
        key: GITHUB_WEBHOOK_SECRET

---
# Example: Sync entire Doppler config as a secret
# Use this for simpler setups where you want all secrets synced
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: enclii-doppler-full
  namespace: enclii
  labels:
    app.kubernetes.io/name: enclii
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: doppler-store
    kind: ClusterSecretStore
  target:
    name: enclii-doppler-full
    creationPolicy: Owner
  # Sync all secrets from the Doppler config
  dataFrom:
    - find:
        name:
          regexp: ".*"

---
# Example: ExternalSecret for builds namespace
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: build-secrets
  namespace: enclii-builds
  labels:
    app.kubernetes.io/name: roundhouse
    app.kubernetes.io/component: secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: doppler-store
    kind: ClusterSecretStore
  target:
    name: build-secrets
    creationPolicy: Owner
  data:
    # Registry credentials
    - secretKey: registry-username
      remoteRef:
        key: REGISTRY_USERNAME

    - secretKey: registry-password
      remoteRef:
        key: REGISTRY_PASSWORD

    # Git credentials for private repos
    - secretKey: git-token
      remoteRef:
        key: GITHUB_TOKEN

    # Cosign key for image signing
    - secretKey: cosign-key
      remoteRef:
        key: COSIGN_PRIVATE_KEY
