---
# Kyverno Best Practice Policies for Enclii
# These policies audit resources for operational best practices
---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-resource-limits
  annotations:
    policies.kyverno.io/title: Require Resource Limits
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Resource limits prevent containers from consuming excessive
      cluster resources. This policy audits pods without CPU/memory limits.
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: require-limits
      match:
        any:
          - resources:
              kinds:
                - Pod
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - kyverno
      validate:
        message: "Resource limits (CPU and memory) are required for all containers."
        pattern:
          spec:
            containers:
              - resources:
                  limits:
                    memory: "?*"
                    cpu: "?*"
---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-labels
  annotations:
    policies.kyverno.io/title: Require Standard Labels
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/severity: low
    policies.kyverno.io/subject: Pod, Deployment
    policies.kyverno.io/description: >-
      Standard labels improve observability and resource management.
      This policy audits resources without app.kubernetes.io labels.
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: require-app-label
      match:
        any:
          - resources:
              kinds:
                - Deployment
                - StatefulSet
                - DaemonSet
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - kyverno
      validate:
        message: "Resources should have app.kubernetes.io/name label for proper identification."
        pattern:
          metadata:
            labels:
              app.kubernetes.io/name: "?*"
---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-probes
  annotations:
    policies.kyverno.io/title: Require Health Probes
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Health probes enable Kubernetes to detect and recover from
      application failures. This policy audits pods without probes.
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: require-readiness-probe
      match:
        any:
          - resources:
              kinds:
                - Pod
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - kyverno
                - enclii-builds  # Build jobs don't need probes
      validate:
        message: "Readiness probes are recommended for all containers."
        anyPattern:
          - spec:
              containers:
                - readinessProbe:
                    httpGet:
                      path: "?*"
          - spec:
              containers:
                - readinessProbe:
                    tcpSocket:
                      port: "?*"
          - spec:
              containers:
                - readinessProbe:
                    exec:
                      command: "?*"
---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disallow-latest-tag
  annotations:
    policies.kyverno.io/title: Disallow Latest Tag
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Using the :latest tag makes deployments unpredictable.
      This policy audits pods using :latest or no tag.
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: disallow-latest
      match:
        any:
          - resources:
              kinds:
                - Pod
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
      validate:
        message: "Using ':latest' tag is not recommended. Specify a version tag."
        pattern:
          spec:
            containers:
              - image: "!*:latest"
            =(initContainers):
              - image: "!*:latest"
---
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-image-digest
  annotations:
    policies.kyverno.io/title: Require Image Digest
    policies.kyverno.io/category: Supply Chain Security
    policies.kyverno.io/severity: low
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Image digests ensure immutable deployments by pinning
      exact image versions. This policy audits pods without digests.
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: require-digest
      match:
        any:
          - resources:
              kinds:
                - Pod
              namespaces:
                - enclii  # Only production namespace for now
      validate:
        message: "Production images should use digests (@sha256:...) for immutability."
        pattern:
          spec:
            containers:
              - image: "*@sha256:*"
