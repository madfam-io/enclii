---
# ArgoCD Image Updater Registry Configuration
# ConfigMap for registry authentication and settings
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-image-updater-config
  namespace: argocd
data:
  # Log level: debug, info, warn, error
  log.level: info

  # Registries configuration
  registries.conf: |
    registries:
      # GitHub Container Registry (primary registry for Enclii)
      - name: ghcr
        api_url: https://ghcr.io
        prefix: ghcr.io
        # Use pull secret for authentication (avoids rate limits)
        credentials: pullsecret:argocd/ghcr-credentials
        default: true

      # Docker Hub (for base images)
      - name: dockerhub
        api_url: https://registry-1.docker.io
        prefix: docker.io
        # Anonymous for public images, add credentials if needed

      # Google Container Registry (for Google-provided images)
      - name: gcr
        api_url: https://gcr.io
        prefix: gcr.io

  # Git repositories configuration
  git.repositories: |
    - url: https://github.com/madfam-org/enclii.git
      name: enclii
      # Credentials for write-back
      credentials: secret:argocd/git-creds

  # Application defaults
  applications.defaults: |
    # Default update strategy
    update-strategy: semver
    # Default write-back method
    write-back-method: git
    # Default branch for commits
    write-back-target: kustomization
    # Commit message template
    git.commit-message-template: |
      chore(images): update {{ .AppName }} to {{ .NewImage }}

      Updated by ArgoCD Image Updater
      - Application: {{ .AppName }}
      - Image: {{ .Image }}
      - Old Tag: {{ .OldTag }}
      - New Tag: {{ .NewTag }}
# --- SECRETS (managed out-of-band, NOT via GitOps) ---
#
# The following secrets must be created manually or via ExternalSecrets.
# Template variables (${...}) in YAML are NOT interpolated by ArgoCD or kubectl —
# they deploy as literal strings, breaking authentication.
#
# 1. ghcr-credentials (registry pull auth — type: docker-registry):
#    kubectl create secret docker-registry ghcr-credentials -n argocd \
#      --docker-server=ghcr.io \
#      --docker-username=<github-user> \
#      --docker-password=<github-pat-with-read:packages>
#
# 2. git-creds (Image Updater git write-back auth — type: generic):
#    kubectl create secret generic git-creds -n argocd \
#      --from-literal=username=<github-user-with-push-access> \
#      --from-literal=password=<github-pat-with-repo-scope>
#
# GitHub identity notes:
# - Org: madfam-org (repository owner)
# - Bot: madfam-bot (dedicated automation account with Write access)
# - Owner user: madfam-io (org admin, fallback if no bot)
# - PAT must have write access to madfam-org/enclii
#
# To use the setup script instead:
#   export GITHUB_USERNAME=madfam-bot
#   export GITHUB_TOKEN=ghp_your_pat_here
#   ./infra/argocd/setup-credentials.sh
